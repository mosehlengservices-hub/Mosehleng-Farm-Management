<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mosehleng Farm | Complete Vegetable Farm Management</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --primary: #2E7D32; --secondary: #6c757d; --accent: #1565C0;
            --success: #4CAF50; --warning: #FF9800; --danger: #F44336;
            --info: #2196F3; --soil: #8D6E63; --water: #1E90FF;
            --bg-light: #FAF3E0; --card-bg: #FFFFFF;
            --cabbage: #8BC34A; --tomato: #F44336; --spinach: #4CAF50;
            --carrot: #FF9800; --onion: #9C27B0; --beetroot: #D32F2F;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Header */
        .app-header {
            background: linear-gradient(135deg, var(--primary), #1b5e20);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 3px 15px rgba(0,0,0,0.2);
        }
        .header-title { 
            font-size: 1.5rem; 
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* Main Navigation */
        .main-nav {
            display: flex;
            overflow-x: auto;
            background: white;
            border-bottom: 3px solid var(--primary);
            padding: 12px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .nav-btn {
            padding: 12px 24px;
            white-space: nowrap;
            background: #f5f5f5;
            border: none;
            border-radius: 30px;
            margin: 0 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.95rem;
        }
        .nav-btn:hover {
            background: #e8f5e9;
            transform: translateY(-2px);
        }
        .nav-btn.active {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(46, 125, 50, 0.4);
        }

        /* Main Content */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 25px;
        }

        /* Section Management */
        .section { 
            display: none;
            animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .section.active { 
            display: block; 
        }

        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: 18px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            border-left: 6px solid var(--primary);
            transition: transform 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .card-title {
            color: var(--primary);
            margin-bottom: 25px;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 700;
        }

        /* Grid Layouts */
        .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 25px; }
        .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .grid-4 { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 18px; }

        /* Form Elements */
        .form-group { margin-bottom: 24px; }
        .form-label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #555;
            font-size: 0.95rem;
        }
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s;
            background: #fff;
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 4px rgba(46, 125, 50, 0.15);
        }
        .form-textarea { min-height: 120px; resize: vertical; }

        /* Buttons */
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 1rem;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), #1b5e20);
            color: white;
        }
        .btn-primary:hover { background: linear-gradient(135deg, #1b5e20, #2E7D32); }
        .btn-secondary {
            background: linear-gradient(135deg, var(--secondary), #5a6268);
            color: white;
        }
        .btn-success {
            background: linear-gradient(135deg, var(--success), #388E3C);
            color: white;
        }
        .btn-warning {
            background: linear-gradient(135deg, var(--warning), #F57C00);
            color: white;
        }
        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #C62828);
            color: white;
        }
        .btn-info {
            background: linear-gradient(135deg, var(--info), #1976D2);
            color: white;
        }
        .btn-small {
            padding: 10px 18px;
            font-size: 0.9rem;
        }
        .btn-icon {
            padding: 10px;
            width: 40px;
            height: 40px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
        }

        /* Tabs System */
        .tabs-container { 
            margin-top: 25px;
            background: white;
            border-radius: 18px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        .tabs-header {
            display: flex;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-bottom: 2px solid #dee2e6;
            overflow-x: auto;
            padding: 0 20px;
        }
        .tab-btn {
            padding: 18px 28px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            position: relative;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
            min-width: 120px;
            justify-content: center;
        }
        .tab-btn:hover {
            background: rgba(255,255,255,0.5);
        }
        .tab-btn.active {
            color: var(--primary);
            background: white;
        }
        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary);
            border-radius: 2px 2px 0 0;
        }
        .tab-content {
            display: none;
            padding: 30px;
            animation: fadeIn 0.3s ease;
        }
        .tab-content.active { 
            display: block; 
        }

        /* Data Tables */
        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 20px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .data-table th {
            background: linear-gradient(135deg, var(--primary), #1b5e20);
            padding: 16px 20px;
            text-align: left;
            font-weight: 600;
            color: white;
            border: none;
        }
        .data-table td {
            padding: 16px 20px;
            border-bottom: 1px solid #eee;
            background: white;
        }
        .data-table tr:hover td {
            background: #f8f9fa;
        }
        .data-table tr:last-child td {
            border-bottom: none;
        }

        /* Status Badges */
        .status-badge {
            padding: 6px 16px;
            border-radius: 25px;
            font-size: 0.85rem;
            font-weight: 700;
            display: inline-block;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .status-active { background: #e8f5e9; color: var(--primary); }
        .status-warning { background: #fff3e0; color: var(--warning); }
        .status-danger { background: #ffebee; color: var(--danger); }
        .status-completed { background: #e8f5e9; color: #4caf50; }
        .status-pending { background: #e3f2fd; color: var(--info); }

        /* Progress Bars */
        .progress-container {
            background: #f0f0f0;
            border-radius: 12px;
            height: 14px;
            margin: 20px 0;
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            border-radius: 12px;
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: shimmer 2s infinite;
        }

        /* Worker Cards */
        .worker-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            border: 1px solid #e9ecef;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .worker-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.15);
        }

        /* Project Tracking Timeline */
        .tracking-timeline {
            position: relative;
            padding-left: 40px;
            margin: 25px 0;
        }
        .tracking-timeline::before {
            content: '';
            position: absolute;
            left: 15px;
            top: 0;
            bottom: 0;
            width: 3px;
            background: linear-gradient(to bottom, var(--primary), var(--accent));
        }
        .timeline-item {
            position: relative;
            margin-bottom: 25px;
            padding-left: 25px;
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -15px;
            top: 8px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary);
            border: 5px solid white;
            box-shadow: 0 0 0 3px var(--primary);
        }
        .timeline-item.completed::before { background: var(--success); box-shadow: 0 0 0 3px var(--success); }
        .timeline-item.in-progress::before { background: var(--warning); box-shadow: 0 0 0 3px var(--warning); }
        .timeline-date {
            font-size: 0.95rem;
            color: var(--primary);
            font-weight: 700;
            margin-bottom: 5px;
        }
        .timeline-content {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-top: 8px;
            border-left: 4px solid var(--primary);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 2000;
            overflow-y: auto;
            padding: 20px;
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 35px;
            max-width: 700px;
            margin: 50px auto;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            position: relative;
            animation: modalSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            color: #666;
            transition: color 0.3s;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-close:hover {
            background: #f5f5f5;
            color: var(--danger);
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 30px;
            right: 30px;
            padding: 18px 30px;
            border-radius: 12px;
            color: white;
            z-index: 10000;
            animation: slideInRight 0.4s ease, fadeOut 0.4s ease 2.6s forwards;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            max-width: 350px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .notification-success { background: linear-gradient(135deg, var(--success), #388E3C); }
        .notification-error { background: linear-gradient(135deg, var(--danger), #C62828); }
        .notification-info { background: linear-gradient(135deg, var(--info), #1976D2); }

        /* Charts and Visualizations */
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border-top: 5px solid var(--primary);
            transition: transform 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .stat-value {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--primary);
            margin: 15px 0;
        }
        .stat-label {
            font-size: 1rem;
            color: #666;
            font-weight: 600;
        }

        /* Mobile Responsive */
        @media (max-width: 992px) {
            .container { padding: 15px; }
            .card { padding: 25px; }
            .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; }
            .main-nav { padding: 8px 15px; }
            .nav-btn { padding: 10px 18px; margin: 0 5px; }
            .tab-btn { padding: 15px 20px; min-width: 100px; }
            .modal-content { margin: 20px auto; padding: 25px; }
        }

        @media (max-width: 768px) {
            .header-title { font-size: 1.2rem; }
            .nav-btn span { display: none; }
            .nav-btn i { font-size: 1.3rem; }
            .nav-btn { padding: 12px; margin: 0 3px; }
            .tab-btn span { display: none; }
            .tab-btn i { font-size: 1.3rem; }
            .stat-value { font-size: 2rem; }
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(100px); }
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(-50px) scale(0.9); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="app-header">
        <div class="header-title">
            <i class="fas fa-seedling"></i> Mosehleng Vegetable Farm Management
        </div>
        <div style="font-size: 0.9rem; display: flex; align-items: center; gap: 15px;">
            <span><i class="fas fa-sync-alt"></i> <span id="lastSave">Auto-saved</span></span>
            <span><i class="fas fa-user"></i> <span id="currentUser">Admin</span></span>
        </div>
    </div>

    <!-- Main Navigation -->
    <div class="main-nav">
        <button class="nav-btn active" data-section="dashboard">
            <i class="fas fa-home"></i><span>Dashboard</span>
        </button>
        <button class="nav-btn" data-section="projectTracking">
            <i class="fas fa-project-diagram"></i><span>Project Tracking</span>
        </button>
        <button class="nav-btn" data-section="farmActivities">
            <i class="fas fa-tractor"></i><span>Farm Activities</span>
        </button>
        <button class="nav-btn" data-section="financing">
            <i class="fas fa-hand-holding-usd"></i><span>Financing</span>
        </button>
        <button class="nav-btn" data-section="investors">
            <i class="fas fa-user-tie"></i><span>Investors</span>
        </button>
        <button class="nav-btn" data-section="budget">
            <i class="fas fa-calculator"></i><span>Budget</span>
        </button>
        <button class="nav-btn" data-section="workers">
            <i class="fas fa-users"></i><span>Workers & Payroll</span>
        </button>
        <button class="nav-btn" data-section="reports">
            <i class="fas fa-chart-bar"></i><span>Reports</span>
        </button>
    </div>

    <!-- Main Content -->
    <div class="container">
        
        <!-- DASHBOARD SECTION -->
        <div id="dashboard" class="section active">
            <div class="grid-3">
                <div class="stat-card">
                    <i class="fas fa-seedling fa-2x" style="color: var(--primary);"></i>
                    <div class="stat-value" id="activeProjects">0</div>
                    <div class="stat-label">Active Projects</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-money-bill-wave fa-2x" style="color: var(--success);"></i>
                    <div class="stat-value" id="totalInvestment">R 0</div>
                    <div class="stat-label">Total Investment</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-users fa-2x" style="color: var(--info);"></i>
                    <div class="stat-value" id="workersCount">0</div>
                    <div class="stat-label">Workers Today</div>
                </div>
            </div>

            <div class="grid-2">
                <div class="card">
                    <h3 class="card-title"><i class="fas fa-chart-line"></i> Project Progress</h3>
                    <div id="projectsProgress">
                        <!-- Projects will be loaded here -->
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title"><i class="fas fa-exclamation-triangle"></i> Recent Activities</h3>
                    <div id="recentActivities" style="max-height: 400px; overflow-y: auto;">
                        <!-- Activities will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- PROJECT TRACKING SECTION -->
        <div id="projectTracking" class="section">
            <div class="card">
                <h2 class="card-title"><i class="fas fa-project-diagram"></i> Vegetable Production Project Tracking</h2>
                
                <div class="tabs-container">
                    <div class="tabs-header">
                        <button class="tab-btn active" data-tab="newProject">
                            <i class="fas fa-plus-circle"></i><span>New Project</span>
                        </button>
                        <button class="tab-btn" data-tab="projectTimeline">
                            <i class="fas fa-road"></i><span>Project Timeline</span>
                        </button>
                        <button class="tab-btn" data-tab="allProjects">
                            <i class="fas fa-list"></i><span>All Projects</span>
                        </button>
                    </div>

                    <!-- New Project Tab -->
                    <div class="tab-content active" id="newProjectTab">
                        <div class="grid-2">
                            <div>
                                <h3>Start New Vegetable Project</h3>
                                <div class="form-group">
                                    <label class="form-label">Project Name *</label>
                                    <input type="text" class="form-input" id="projectName" placeholder="e.g., Summer Cabbage Production">
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Select Vegetable Crop *</label>
                                    <select class="form-select" id="vegetableCrop" onchange="updateCropDetails()">
                                        <option value="">Choose Crop</option>
                                        <option value="cabbage">Cabbage (Conquistador F1)</option>
                                        <option value="beetroot">Beetroot</option>
                                        <option value="carrots">Carrots</option>
                                        <option value="onions">Onions</option>
                                        <option value="spinach">Spinach</option>
                                        <option value="cauliflower">Cauliflower</option>
                                        <option value="broccoli">Broccoli</option>
                                        <option value="tomatoes">Tomatoes</option>
                                        <option value="turnips">Turnips</option>
                                        <option value="lettuce">Lettuce</option>
                                        <option value="kale">Kale</option>
                                    </select>
                                </div>

                                <div class="grid-2">
                                    <div class="form-group">
                                        <label class="form-label">Area Size (ha) *</label>
                                        <input type="number" class="form-input" id="projectArea" step="0.01" min="0.1" value="1" oninput="calculateProjectDetails()">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Expected Plants</label>
                                        <input type="number" class="form-input" id="expectedPlants" readonly>
                                    </div>
                                </div>

                                <div class="grid-2">
                                    <div class="form-group">
                                        <label class="form-label">Start Date *</label>
                                        <input type="date" class="form-input" id="projectStartDate">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Expected Harvest Date</label>
                                        <input type="date" class="form-input" id="projectHarvestDate">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Location/Plot *</label>
                                    <input type="text" class="form-input" id="projectLocation" placeholder="e.g., North Field Block A">
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Project Description</label>
                                    <textarea class="form-textarea" id="projectDescription" placeholder="Project goals, special instructions..."></textarea>
                                </div>

                                <button class="btn btn-primary" id="createProjectBtn">
                                    <i class="fas fa-check-circle"></i> Create Project
                                </button>
                            </div>

                            <div>
                                <h3>Crop Details</h3>
                                <div id="cropDetails" style="background: linear-gradient(135deg, #e8f5e9, #c8e6c9); padding: 25px; border-radius: 12px; margin-bottom: 25px;">
                                    <h4 style="color: var(--primary);">Select a crop for details</h4>
                                    <div id="cropSpecifics">
                                        <!-- Crop details will appear here -->
                                    </div>
                                </div>

                                <h3>Project Requirements</h3>
                                <div id="projectRequirements" style="background: #f8f9fa; padding: 20px; border-radius: 12px;">
                                    <!-- Project requirements will appear here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Project Timeline Tab -->
                    <div class="tab-content" id="projectTimelineTab">
                        <div class="form-group">
                            <label class="form-label">Select Project</label>
                            <select class="form-select" id="timelineProject" onchange="loadProjectTimeline()">
                                <option value="">Choose Project</option>
                            </select>
                        </div>

                        <div id="projectTimelineView" class="tracking-timeline">
                            <!-- Timeline will be loaded here -->
                        </div>

                        <h3 style="margin-top: 30px;">Update Project Status</h3>
                        <div class="grid-3">
                            <div class="form-group">
                                <label class="form-label">Current Stage</label>
                                <select class="form-select" id="currentStage">
                                    <option value="soil_preparation">Soil Preparation</option>
                                    <option value="seedling_preparation">Seedling Preparation</option>
                                    <option value="planting">Planting</option>
                                    <option value="irrigation">Irrigation Setup</option>
                                    <option value="fertilizer_application">Fertilizer Application</option>
                                    <option value="pest_control">Pest Control</option>
                                    <option value="disease_control">Disease Control</option>
                                    <option value="weed_control">Weed Control</option>
                                    <option value="harvesting">Harvesting</option>
                                    <option value="post_harvest">Post-Harvest</option>
                                    <option value="marketing">Marketing & Sales</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Status</label>
                                <select class="form-select" id="stageStatus">
                                    <option value="planned">Planned</option>
                                    <option value="in_progress">In Progress</option>
                                    <option value="completed">Completed</option>
                                    <option value="delayed">Delayed</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Date</label>
                                <input type="date" class="form-input" id="stageDate" value="">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Notes</label>
                            <textarea class="form-textarea" id="stageNotes" placeholder="Add notes about this stage..."></textarea>
                        </div>

                        <button class="btn btn-success" id="updateStageBtn">
                            <i class="fas fa-save"></i> Update Project Stage
                        </button>
                    </div>

                    <!-- All Projects Tab -->
                    <div class="tab-content" id="allProjectsTab">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3>All Vegetable Projects</h3>
                            <div style="display: flex; gap: 10px;">
                                <select class="form-select" id="projectFilter" style="width: 150px;">
                                    <option value="all">All Projects</option>
                                    <option value="active">Active</option>
                                    <option value="completed">Completed</option>
                                    <option value="delayed">Delayed</option>
                                </select>
                                <input type="text" class="form-input" placeholder="Search projects..." id="projectSearch" style="width: 200px;">
                            </div>
                        </div>

                        <div id="projectsList" class="grid-3">
                            <!-- Projects will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- FARM ACTIVITIES SECTION -->
        <div id="farmActivities" class="section">
            <div class="card">
                <h2 class="card-title"><i class="fas fa-tractor"></i> Farm Activities Recording</h2>
                
                <div class="tabs-container">
                    <div class="tabs-header">
                        <button class="tab-btn active" data-tab="dailyActivities">
                            <i class="fas fa-calendar-day"></i><span>Daily Activities</span>
                        </button>
                        <button class="tab-btn" data-tab="chemicals">
                            <i class="fas fa-flask"></i><span>Chemicals Application</span>
                        </button>
                        <button class="tab-btn" data-tab="irrigation">
                            <i class="fas fa-tint"></i><span>Irrigation</span>
                        </button>
                    </div>

                    <!-- Daily Activities Tab -->
                    <div class="tab-content active" id="dailyActivitiesTab">
                        <div class="grid-2">
                            <div>
                                <h3>Record Daily Activity</h3>
                                <div class="form-group">
                                    <label class="form-label">Select Project</label>
                                    <select class="form-select" id="activityProject">
                                        <option value="">Choose Project</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Activity Type</label>
                                    <select class="form-select" id="activityType">
                                        <option value="soil_preparation">Soil Preparation</option>
                                        <option value="ploughing">Ploughing</option>
                                        <option value="harrowing">Harrowing</option>
                                        <option value="planting">Planting</option>
                                        <option value="thinning">Thinning</option>
                                        <option value="weeding">Weeding</option>
                                        <option value="harvesting">Harvesting</option>
                                        <option value="packing">Packing</option>
                                        <option value="transport">Transport</option>
                                        <option value="maintenance">Equipment Maintenance</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>

                                <div class="grid-2">
                                    <div class="form-group">
                                        <label class="form-label">Date *</label>
                                        <input type="date" class="form-input" id="activityDate" value="">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Hours Spent</label>
                                        <input type="number" class="form-input" id="activityHours" step="0.5" min="0" value="8">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Description *</label>
                                    <textarea class="form-textarea" id="activityDescription" placeholder="Describe the activity performed..."></textarea>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Workers Involved</label>
                                    <select class="form-select" id="activityWorkers" multiple style="height: 100px;">
                                        <!-- Workers will be populated -->
                                    </select>
                                    <small style="color: #666;">Hold Ctrl/Cmd to select multiple workers</small>
                                </div>

                                <button class="btn btn-primary" id="saveActivityBtn">
                                    <i class="fas fa-save"></i> Save Activity
                                </button>
                            </div>

                            <div>
                                <h3>Today's Activities</h3>
                                <div id="todayActivities" style="max-height: 500px; overflow-y: auto;">
                                    <!-- Today's activities will appear here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Chemicals Application Tab -->
                    <div class="tab-content" id="chemicalsTab">
                        <div class="grid-2">
                            <div>
                                <h3>Record Chemical Application</h3>
                                <div class="form-group">
                                    <label class="form-label">Select Project</label>
                                    <select class="form-select" id="chemicalProject">
                                        <option value="">Choose Project</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Chemical Type</label>
                                    <select class="form-select" id="chemicalType">
                                        <option value="fertilizer">Fertilizer</option>
                                        <option value="pesticide">Pesticide</option>
                                        <option value="fungicide">Fungicide</option>
                                        <option value="herbicide">Herbicide</option>
                                        <option value="insecticide">Insecticide</option>
                                        <option value="growth_regulator">Growth Regulator</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Chemical Name *</label>
                                    <input type="text" class="form-input" id="chemicalName" placeholder="e.g., NPK 2:3:4, Glyphosate">
                                </div>

                                <div class="grid-3">
                                    <div class="form-group">
                                        <label class="form-label">Quantity</label>
                                        <input type="number" class="form-input" id="chemicalQuantity" step="0.01" min="0">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Unit</label>
                                        <select class="form-select" id="chemicalUnit">
                                            <option value="kg">kg</option>
                                            <option value="litre">Litre</option>
                                            <option value="ml">ml</option>
                                            <option value="bag">Bag</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Area Covered (ha)</label>
                                        <input type="number" class="form-input" id="chemicalArea" step="0.01" min="0">
                                    </div>
                                </div>

                                <div class="grid-2">
                                    <div class="form-group">
                                        <label class="form-label">Application Date *</label>
                                        <input type="date" class="form-input" id="chemicalDate" value="">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Next Application</label>
                                        <input type="date" class="form-input" id="chemicalNextDate">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Application Method</label>
                                    <select class="form-select" id="chemicalMethod">
                                        <option value="spraying">Spraying</option>
                                        <option value="broadcasting">Broadcasting</option>
                                        <option value="drip">Drip Irrigation</option>
                                        <option value="foliar">Foliar Application</option>
                                        <option value="soil_incorporation">Soil Incorporation</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Notes / Safety Precautions</label>
                                    <textarea class="form-textarea" id="chemicalNotes" placeholder="Any special instructions or observations..."></textarea>
                                </div>

                                <button class="btn btn-warning" id="saveChemicalBtn">
                                    <i class="fas fa-flask"></i> Record Application
                                </button>
                            </div>

                            <div>
                                <h3>Chemical Application History</h3>
                                <div id="chemicalHistory" style="max-height: 500px; overflow-y: auto;">
                                    <!-- Chemical history will appear here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Irrigation Tab -->
                    <div class="tab-content" id="irrigationTab">
                        <div class="grid-2">
                            <div>
                                <h3>Record Irrigation</h3>
                                <div class="form-group">
                                    <label class="form-label">Select Project</label>
                                    <select class="form-select" id="irrigationProject">
                                        <option value="">Choose Project</option>
                                    </select>
                                </div>

                                <div class="grid-2">
                                    <div class="form-group">
                                        <label class="form-label">Irrigation Date *</label>
                                        <input type="date" class="form-input" id="irrigationDate" value="">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Irrigation Time</label>
                                        <input type="time" class="form-input" id="irrigationTime">
                                    </div>
                                </div>

                                <div class="grid-3">
                                    <div class="form-group">
                                        <label class="form-label">Duration (hours)</label>
                                        <input type="number" class="form-input" id="irrigationDuration" step="0.5" min="0">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Water Used (mÂ³)</label>
                                        <input type="number" class="form-input" id="irrigationWater" step="0.1" min="0">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Area Irrigated (ha)</label>
                                        <input type="number" class="form-input" id="irrigationArea" step="0.01" min="0">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Irrigation Method</label>
                                    <select class="form-select" id="irrigationMethod">
                                        <option value="drip">Drip Irrigation</option>
                                        <option value="sprinkler">Sprinkler</option>
                                        <option value="flood">Flood Irrigation</option>
                                        <option value="center_pivot">Center Pivot</option>
                                        <option value="hand_watering">Hand Watering</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Soil Moisture Level</label>
                                    <select class="form-select" id="soilMoisture">
                                        <option value="dry">Dry</option>
                                        <option value="moist">Moist</option>
                                        <option value="wet">Wet</option>
                                        <option value="waterlogged">Waterlogged</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Notes</label>
                                    <textarea class="form-textarea" id="irrigationNotes" placeholder="Observations about the irrigation..."></textarea>
                                </div>

                                <button class="btn btn-info" id="saveIrrigationBtn">
                                    <i class="fas fa-tint"></i> Record Irrigation
                                </button>
                            </div>

                            <div>
                                <h3>Irrigation Schedule</h3>
                                <div id="irrigationSchedule" style="max-height: 500px; overflow-y: auto;">
                                    <!-- Irrigation schedule will appear here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- FINANCING SECTION -->
        <div id="financing" class="section">
            <div class="card">
                <h2 class="card-title"><i class="fas fa-hand-holding-usd"></i> Project Financing Management</h2>
                
                <div class="tabs-container">
                    <div class="tabs-header">
                        <button class="tab-btn active" data-tab="financingOverview">
                            <i class="fas fa-chart-pie"></i><span>Overview</span>
                        </button>
                        <button class="tab-btn" data-tab="addFinancing">
                            <i class="fas fa-plus-circle"></i><span>Add Financing</span>
                        </button>
                        <button class="tab-btn" data-tab="financingReports">
                            <i class="fas fa-file-invoice"></i><span>Reports</span>
                        </button>
                    </div>

                    <!-- Financing Overview Tab -->
                    <div class="tab-content active" id="financingOverviewTab">
                        <div class="grid-3">
                            <div class="stat-card">
                                <i class="fas fa-money-check-alt fa-2x" style="color: var(--success);"></i>
                                <div class="stat-value" id="totalLoans">R 0</div>
                                <div class="stat-label">Total Loans</div>
                            </div>
                            <div class="stat-card">
                                <i class="fas fa-gift fa-2x" style="color: var(--info);"></i>
                                <div class="stat-value" id="totalGrants">R 0</div>
                                <div class="stat-label">Total Grants</div>
                            </div>
                            <div class="stat-card">
                                <i class="fas fa-chart-line fa-2x" style="color: var(--primary);"></i>
                                <div class="stat-value" id="financingUtilization">0%</div>
                                <div class="stat-label">Financing Utilized</div>
                            </div>
                        </div>

                        <h3 style="margin-top: 30px;">Financing by Project</h3>
                        <div id="projectFinancingChart">
                            <!-- Financing chart will appear here -->
                        </div>
                    </div>

                    <!-- Add Financing Tab -->
                    <div class="tab-content" id="addFinancingTab">
                        <div class="grid-2">
                            <div>
                                <h3>Add New Financing</h3>
                                <div class="form-group">
                                    <label class="form-label">Financing Type *</label>
                                    <select class="form-select" id="financingType" onchange="toggleFinancingFields()">
                                        <option value="">Select Type</option>
                                        <option value="loan">Loan</option>
                                        <option value="grant">Grant</option>
                                        <option value="investment">Investment</option>
                                        <option value="personal">Personal Contribution</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Project *</label>
                                    <select class="form-select" id="financingProject">
                                        <option value="">Select Project</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Amount (R) *</label>
                                    <input type="number" class="form-input" id="financingAmount" step="0.01" min="0">
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Date Received *</label>
                                    <input type="date" class="form-input" id="financingDate" value="">
                                </div>

                                <div class="form-group" id="sourceField">
                                    <label class="form-label">Source / Provider</label>
                                    <input type="text" class="form-input" id="financingSource" placeholder="e.g., Land Bank, Government Grant">
                                </div>

                                <div class="form-group" id="interestField" style="display: none;">
                                    <label class="form-label">Interest Rate (%)</label>
                                    <input type="number" class="form-input" id="financingInterest" step="0.01" min="0" max="100">
                                </div>

                                <div class="form-group" id="termsField" style="display: none;">
                                    <label class="form-label">Terms / Conditions</label>
                                    <textarea class="form-textarea" id="financingTerms" placeholder="Repayment terms, conditions..."></textarea>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Purpose / Notes</label>
                                    <textarea class="form-textarea" id="financingPurpose" placeholder="What will this financing be used for?"></textarea>
                                </div>

                                <button class="btn btn-success" id="saveFinancingBtn">
                                    <i class="fas fa-save"></i> Save Financing Record
                                </button>
                            </div>

                            <div>
                                <h3>Recent Financing Records</h3>
                                <div id="recentFinancing" style="max-height: 500px; overflow-y: auto;">
                                    <!-- Recent financing will appear here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Financing Reports Tab -->
                    <div class="tab-content" id="financingReportsTab">
                        <div class="grid-2">
                            <div>
                                <h3>Generate Financing Report</h3>
                                <div class="form-group">
                                    <label class="form-label">Report Type</label>
                                    <select class="form-select" id="financingReportType">
                                        <option value="summary">Financing Summary</option>
                                        <option value="project">Project Financing</option>
                                        <option value="type">Financing by Type</option>
                                        <option value="detailed">Detailed Report</option>
                                    </select>
                                </div>

                                <div class="grid-2">
                                    <div class="form-group">
                                        <label class="form-label">Start Date</label>
                                        <input type="date" class="form-input" id="reportStartDate">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">End Date</label>
                                        <input type="date" class="form-input" id="reportEndDate">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Select Project (Optional)</label>
                                    <select class="form-select" id="reportProject">
                                        <option value="all">All Projects</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Output Format</label>
                                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                                        <button class="btn btn-primary" id="generatePdfReport">
                                            <i class="fas fa-file-pdf"></i> PDF Report
                                        </button>
                                        <button class="btn btn-success" id="generateExcelReport">
                                            <i class="fas fa-file-excel"></i> Excel Report
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div>
                                <h3>Report Preview</h3>
                                <div id="reportPreview" style="background: #f8f9fa; padding: 20px; border-radius: 12px; min-height: 300px;">
                                    <!-- Report preview will appear here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- INVESTORS SECTION -->
        <div id="investors" class="section">
            <div class="card">
                <h2 class="card-title"><i class="fas fa-user-tie"></i> Investor Management</h2>
                
                <div class="tabs-container">
                    <div class="tabs-header">
                        <button class="tab-btn active" data-tab="addInvestment">
                            <i class="fas fa-plus-circle"></i><span>Record Investment</span>
                        </button>
                        <button class="tab-btn" data-tab="investorPortfolio">
                            <i class="fas fa-chart-pie"></i><span>Investor Portfolio</span>
                        </button>
                        <button class="tab-btn" data-tab="investmentHistory">
                            <i class="fas fa-history"></i><span>Investment History</span>
                        </button>
                    </div>

                    <!-- Add Investment Tab -->
                    <div class="tab-content active" id="addInvestmentTab">
                        <div class="grid-2">
                            <div>
                                <h3>Record New Investment</h3>
                                <div class="form-group">
                                    <label class="form-label">Select Investor *</label>
                                    <select class="form-select" id="investorSelect">
                                        <option value="">Choose Investor</option>
                                        <option value="Trevor Nkgapele">Trevor Nkgapele</option>
                                        <option value="Sihle Mdutsane">Sihle Mdutsane</option>
                                        <option value="Moses Mkhabela">Moses Mkhabela</option>
                                        <option value="France Gafane">France Gafane</option>
                                        <option value="other">Other Investor</option>
                                    </select>
                                </div>

                                <div class="form-group" id="otherInvestorField" style="display: none;">
                                    <label class="form-label">Other Investor Name</label>
                                    <input type="text" class="form-input" id="otherInvestorName" placeholder="Enter investor name">
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Investment Type *</label>
                                    <select class="form-select" id="investmentType">
                                        <option value="equity">Equity Investment</option>
                                        <option value="loan">Loan</option>
                                        <option value="grant">Grant</option>
                                        <option value="donation">Donation</option>
                                        <option value="partnership">Partnership</option>
                                    </select>
                                </div>

                                <div class="grid-2">
                                    <div class="form-group">
                                        <label class="form-label">Investment Amount (R) *</label>
                                        <input type="number" class="form-input" id="investmentAmount" step="0.01" min="0">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Investment Date *</label>
                                        <input type="date" class="form-input" id="investmentDate" value="">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Project (Optional)</label>
                                    <select class="form-select" id="investmentProject">
                                        <option value="">Select Project (Optional)</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Payment Method</label>
                                    <select class="form-select" id="paymentMethod">
                                        <option value="bank_transfer">Bank Transfer</option>
                                        <option value="cash">Cash</option>
                                        <option value="cheque">Cheque</option>
                                        <option value="mobile_money">Mobile Money</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Reference / Receipt Number</label>
                                    <input type="text" class="form-input" id="investmentReference" placeholder="e.g., Bank reference, receipt #">
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Terms & Conditions</label>
                                    <textarea class="form-textarea" id="investmentTerms" placeholder="Investment terms, expected returns, etc."></textarea>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Notes</label>
                                    <textarea class="form-textarea" id="investmentNotes" placeholder="Additional notes..."></textarea>
                                </div>

                                <button class="btn btn-primary" id="saveInvestmentBtn">
                                    <i class="fas fa-save"></i> Record Investment
                                </button>
                            </div>

                            <div>
                                <h3>Investor Information</h3>
                                <div id="investorInfo" style="background: #f8f9fa; padding: 25px; border-radius: 12px; margin-bottom: 25px;">
                                    <h4 style="color: var(--primary);">Selected Investor Details</h4>
                                    <div id="investorDetails">
                                        <p>Select an investor to view details</p>
                                    </div>
                                </div>

                                <h3>Recent Investments</h3>
                                <div id="recentInvestments" style="max-height: 400px; overflow-y: auto;">
                                    <!-- Recent investments will appear here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Investor Portfolio Tab -->
                    <div class="tab-content" id="investorPortfolioTab">
                        <div class="grid-4" id="investorPortfolioGrid">
                            <!-- Investor portfolio cards will appear here -->
                        </div>

                        <h3 style="margin-top: 30px;">Investment Distribution</h3>
                        <div id="investmentDistribution" style="height: 300px; background: #f8f9fa; border-radius: 12px; padding: 20px;">
                            <!-- Investment distribution chart will appear here -->
                        </div>
                    </div>

                    <!-- Investment History Tab -->
                    <div class="tab-content" id="investmentHistoryTab">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3>Investment History</h3>
                            <div style="display: flex; gap: 10px;">
                                <select class="form-select" id="investmentFilter" style="width: 150px;">
                                    <option value="all">All Investments</option>
                                    <option value="Trevor Nkgapele">Trevor Nkgapele</option>
                                    <option value="Sihle Mdutsane">Sihle Mdutsane</option>
                                    <option value="Moses Mkhabela">Moses Mkhabela</option>
                                    <option value="France Gafane">France Gafane</option>
                                    <option value="other">Other Investors</option>
                                </select>
                                <input type="date" class="form-input" id="investmentHistoryDate" style="width: 150px;">
                            </div>
                        </div>

                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Investor</th>
                                    <th>Type</th>
                                    <th>Amount</th>
                                    <th>Project</th>
                                    <th>Reference</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="investmentHistoryTable">
                                <!-- Investment history will appear here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- BUDGET SECTION -->
        <div id="budget" class="section">
            <div class="card">
                <h2 class="card-title"><i class="fas fa-calculator"></i> Budget Planning & Tracking</h2>
                
                <div class="tabs-container">
                    <div class="tabs-header">
                        <button class="tab-btn active" data-tab="createBudget">
                            <i class="fas fa-pencil-alt"></i><span>Create Budget</span>
                        </button>
                        <button class="tab-btn" data-tab="budgetTracking">
                            <i class="fas fa-chart-line"></i><span>Track Budget</span>
                        </button>
                        <button class="tab-btn" data-tab="expenses">
                            <i class="fas fa-money-bill-wave"></i><span>Expenses</span>
                        </button>
                    </div>

                    <!-- Create Budget Tab -->
                    <div class="tab-content active" id="createBudgetTab">
                        <div class="grid-2">
                            <div>
                                <h3>Create New Budget</h3>
                                <div class="form-group">
                                    <label class="form-label">Budget For Project *</label>
                                    <select class="form-select" id="budgetProject">
                                        <option value="">Select Project</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Budget Name *</label>
                                    <input type="text" class="form-input" id="budgetName" placeholder="e.g., Summer Cabbage Budget">
                                </div>

                                <div class="grid-2">
                                    <div class="form-group">
                                        <label class="form-label">Start Date *</label>
                                        <input type="date" class="form-input" id="budgetStartDate" value="">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">End Date *</label>
                                        <input type="date" class="form-input" id="budgetEndDate">
                                    </div>
                                </div>

                                <h4 style="margin-top: 25px; margin-bottom: 15px;">Budget Items</h4>
                                <div id="budgetItemsContainer">
                                    <div class="budget-item" style="margin-bottom: 15px; padding: 15px; border: 1px dashed #ddd; border-radius: 8px;">
                                        <div class="grid-4">
                                            <div class="form-group">
                                                <label class="form-label">Category</label>
                                                <select class="form-select budget-category">
                                                    <option value="seeds">Seeds/Seedlings</option>
                                                    <option value="fertilizer">Fertilizer</option>
                                                    <option value="pesticides">Pesticides</option>
                                                    <option value="labor">Labor</option>
                                                    <option value="irrigation">Irrigation</option>
                                                    <option value="equipment">Equipment</option>
                                                    <option value="fuel">Fuel</option>
                                                    <option value="transport">Transport</option>
                                                    <option value="packaging">Packaging</option>
                                                    <option value="marketing">Marketing</option>
                                                    <option value="other">Other</option>
                                                </select>
                                            </div>
                                            <div class="form-group">
                                                <label class="form-label">Item Description</label>
                                                <input type="text" class="form-input budget-description" placeholder="Item description">
                                            </div>
                                            <div class="form-group">
                                                <label class="form-label">Quantity</label>
                                                <input type="number" class="form-input budget-quantity" step="0.01" min="0" value="1">
                                            </div>
                                            <div class="form-group">
                                                <label class="form-label">Unit Cost (R)</label>
                                                <input type="number" class="form-input budget-unit-cost" step="0.01" min="0" value="0">
                                            </div>
                                        </div>
                                        <div class="grid-2">
                                            <div class="form-group">
                                                <label class="form-label">Unit</label>
                                                <select class="form-select budget-unit">
                                                    <option value="kg">kg</option>
                                                    <option value="litre">Litre</option>
                                                    <option value="bag">Bag</option>
                                                    <option value="packet">Packet</option>
                                                    <option value="person-day">Person-day</option>
                                                    <option value="hectare">Hectare</option>
                                                    <option value="unit">Unit</option>
                                                </select>
                                            </div>
                                            <div class="form-group">
                                                <label class="form-label">Total Cost (R)</label>
                                                <input type="number" class="form-input budget-total" readonly value="0">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                                    <button class="btn btn-small btn-primary" id="addBudgetItemBtn">
                                        <i class="fas fa-plus"></i> Add Item
                                    </button>
                                    <button class="btn btn-small btn-secondary" id="removeBudgetItemBtn">
                                        <i class="fas fa-minus"></i> Remove Item
                                    </button>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Total Budget (R)</label>
                                    <input type="number" class="form-input" id="totalBudget" readonly style="font-size: 1.2rem; font-weight: bold;">
                                </div>

                                <button class="btn btn-success" id="saveBudgetBtn">
                                    <i class="fas fa-save"></i> Save Budget
                                </button>
                            </div>

                            <div>
                                <h3>Budget Preview</h3>
                                <div id="budgetPreview" style="background: #f8f9fa; padding: 20px; border-radius: 12px; max-height: 500px; overflow-y: auto;">
                                    <!-- Budget preview will appear here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Budget Tracking Tab -->
                    <div class="tab-content" id="budgetTrackingTab">
                        <div class="grid-2">
                            <div>
                                <h3>Budget vs Actual</h3>
                                <div id="budgetTrackingChart">
                                    <!-- Budget tracking chart will appear here -->
                                </div>
                            </div>

                            <div>
                                <h3>Select Budget to Track</h3>
                                <div class="form-group">
                                    <label class="form-label">Select Project Budget</label>
                                    <select class="form-select" id="trackingBudget" onchange="loadBudgetTracking()">
                                        <option value="">Choose Budget</option>
                                    </select>
                                </div>

                                <div id="budgetTrackingSummary" style="background: #f8f9fa; padding: 25px; border-radius: 12px; margin-top: 20px;">
                                    <!-- Budget tracking summary will appear here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Expenses Tab -->
                    <div class="tab-content" id="expensesTab">
                        <div class="grid-2">
                            <div>
                                <h3>Record Expense</h3>
                                <div class="form-group">
                                    <label class="form-label">Project *</label>
                                    <select class="form-select" id="expenseProject">
                                        <option value="">Select Project</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Expense Category *</label>
                                    <select class="form-select" id="expenseCategory">
                                        <option value="seeds">Seeds/Seedlings</option>
                                        <option value="fertilizer">Fertilizer</option>
                                        <option value="pesticides">Pesticides</option>
                                        <option value="labor">Labor</option>
                                        <option value="irrigation">Irrigation</option>
                                        <option value="equipment">Equipment</option>
                                        <option value="fuel">Fuel</option>
                                        <option value="transport">Transport</option>
                                        <option value="packaging">Packaging</option>
                                        <option value="marketing">Marketing</option>
                                        <option value="administration">Administration</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>

                                <div class="grid-2">
                                    <div class="form-group">
                                        <label class="form-label">Amount (R) *</label>
                                        <input type="number" class="form-input" id="expenseAmount" step="0.01" min="0">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Date *</label>
                                        <input type="date" class="form-input" id="expenseDate" value="">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Description *</label>
                                    <textarea class="form-textarea" id="expenseDescription" placeholder="Describe the expense..."></textarea>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Receipt Number (Optional)</label>
                                    <input type="text" class="form-input" id="expenseReceipt" placeholder="Receipt/Invoice number">
                                </div>

                                <button class="btn btn-primary" id="saveExpenseBtn">
                                    <i class="fas fa-save"></i> Record Expense
                                </button>
                            </div>

                            <div>
                                <h3>Recent Expenses</h3>
                                <div id="recentExpenses" style="max-height: 500px; overflow-y: auto;">
                                    <!-- Recent expenses will appear here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- WORKERS & PAYROLL SECTION -->
        <div id="workers" class="section">
            <div class="card">
                <h2 class="card-title"><i class="fas fa-users"></i> Workers & Payroll Management</h2>
                
                <div class="tabs-container">
                    <div class="tabs-header">
                        <button class="tab-btn active" data-tab="attendance">
                            <i class="fas fa-calendar-check"></i><span>Attendance</span>
                        </button>
                        <button class="tab-btn" data-tab="payroll">
                            <i class="fas fa-money-check"></i><span>Payroll</span>
                        </button>
                        <button class="tab-btn" data-tab="workersList">
                            <i class="fas fa-list"></i><span>Workers List</span>
                        </button>
                    </div>

                    <!-- Attendance Tab -->
                    <div class="tab-content active" id="attendanceTab">
                        <div class="grid-2">
                            <div>
                                <h3>Daily Attendance Register</h3>
                                <div class="form-group">
                                    <label class="form-label">Date *</label>
                                    <input type="date" class="form-input" id="attendanceDate" value="">
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Project (Optional)</label>
                                    <select class="form-select" id="attendanceProject">
                                        <option value="">Select Project</option>
                                    </select>
                                </div>

                                <h4 style="margin-top: 20px;">Mark Attendance</h4>
                                <div id="attendanceList" style="max-height: 400px; overflow-y: auto; margin-top: 15px;">
                                    <!-- Attendance list will appear here -->
                                </div>

                                <button class="btn btn-success" id="saveAttendanceBtn" style="margin-top: 20px;">
                                    <i class="fas fa-save"></i> Save Attendance
                                </button>
                            </div>

                            <div>
                                <h3>Today's Attendance Summary</h3>
                                <div id="attendanceSummary" style="background: #f8f9fa; padding: 25px; border-radius: 12px;">
                                    <!-- Attendance summary will appear here -->
                                </div>

                                <h3 style="margin-top: 30px;">Attendance History</h3>
                                <div id="attendanceHistory" style="max-height: 300px; overflow-y: auto;">
                                    <!-- Attendance history will appear here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Payroll Tab -->
                    <div class="tab-content" id="payrollTab">
                        <div class="grid-2">
                            <div>
                                <h3>Calculate Payroll</h3>
                                <div class="form-group">
                                    <label class="form-label">Pay Period</label>
                                    <select class="form-select" id="payPeriod">
                                        <option value="weekly">Weekly</option>
                                        <option value="monthly">Monthly</option>
                                        <option value="custom">Custom Period</option>
                                    </select>
                                </div>

                                <div id="customPeriodFields" style="display: none;">
                                    <div class="grid-2">
                                        <div class="form-group">
                                            <label class="form-label">Start Date</label>
                                            <input type="date" class="form-input" id="payrollStartDate">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">End Date</label>
                                            <input type="date" class="form-input" id="payrollEndDate">
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Rate per Full Day: R100</label>
                                    <div style="color: #666; font-size: 0.9rem;">Half Day: R50 (50% of full day)</div>
                                </div>

                                <button class="btn btn-primary" id="calculatePayrollBtn">
                                    <i class="fas fa-calculator"></i> Calculate Payroll
                                </button>
                            </div>

                            <div>
                                <h3>Payroll Summary</h3>
                                <div id="payrollSummary" style="background: #f8f9fa; padding: 25px; border-radius: 12px; min-height: 300px;">
                                    <!-- Payroll summary will appear here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Workers List Tab -->
                    <div class="tab-content" id="workersListTab">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3>Workers Database</h3>
                            <button class="btn btn-primary" id="addWorkerBtn">
                                <i class="fas fa-user-plus"></i> Add Worker
                            </button>
                        </div>

                        <div id="workersDatabase" class="grid-3">
                            <!-- Workers database will appear here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- REPORTS SECTION -->
        <div id="reports" class="section">
            <div class="card">
                <h2 class="card-title"><i class="fas fa-chart-bar"></i> Reports & Analytics</h2>
                
                <div class="tabs-container">
                    <div class="tabs-header">
                        <button class="tab-btn active" data-tab="generateReports">
                            <i class="fas fa-file-alt"></i><span>Generate Reports</span>
                        </button>
                        <button class="tab-btn" data-tab="analytics">
                            <i class="fas fa-chart-pie"></i><span>Analytics</span>
                        </button>
                        <button class="tab-btn" data-tab="export">
                            <i class="fas fa-download"></i><span>Export Data</span>
                        </button>
                    </div>

                    <!-- Generate Reports Tab -->
                    <div class="tab-content active" id="generateReportsTab">
                        <div class="grid-2">
                            <div>
                                <h3>Generate Custom Report</h3>
                                <div class="form-group">
                                    <label class="form-label">Report Type</label>
                                    <select class="form-select" id="reportType">
                                        <option value="project_progress">Project Progress Report</option>
                                        <option value="financial_summary">Financial Summary</option>
                                        <option value="investment_report">Investment Report</option>
                                        <option value="budget_variance">Budget vs Actual</option>
                                        <option value="attendance_report">Attendance Report</option>
                                        <option value="payroll_report">Payroll Report</option>
                                        <option value="crop_performance">Crop Performance</option>
                                        <option value="activity_summary">Activity Summary</option>
                                    </select>
                                </div>

                                <div class="grid-2">
                                    <div class="form-group">
                                        <label class="form-label">From Date</label>
                                        <input type="date" class="form-input" id="reportFromDate">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">To Date</label>
                                        <input type="date" class="form-input" id="reportToDate">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Select Project (Optional)</label>
                                    <select class="form-select" id="reportProject">
                                        <option value="all">All Projects</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Report Format</label>
                                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                                        <button class="btn btn-danger" id="generatePdfBtn">
                                            <i class="fas fa-file-pdf"></i> Generate PDF
                                        </button>
                                        <button class="btn btn-success" id="generateExcelBtn">
                                            <i class="fas fa-file-excel"></i> Generate Excel
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div>
                                <h3>Report Preview</h3>
                                <div id="reportOutput" style="background: #f8f9fa; padding: 25px; border-radius: 12px; min-height: 400px; max-height: 500px; overflow-y: auto;">
                                    <!-- Report output will appear here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Analytics Tab -->
                    <div class="tab-content" id="analyticsTab">
                        <div class="grid-3">
                            <div class="stat-card">
                                <i class="fas fa-chart-line fa-2x" style="color: var(--primary);"></i>
                                <div class="stat-value" id="totalYield">0 kg</div>
                                <div class="stat-label">Total Yield</div>
                            </div>
                            <div class="stat-card">
                                <i class="fas fa-money-bill fa-2x" style="color: var(--success);"></i>
                                <div class="stat-value" id="roi">0%</div>
                                <div class="stat-label">ROI</div>
                            </div>
                            <div class="stat-card">
                                <i class="fas fa-user-clock fa-2x" style="color: var(--info);"></i>
                                <div class="stat-value" id="laborCost">R 0</div>
                                <div class="stat-label">Labor Cost</div>
                            </div>
                        </div>

                        <h3 style="margin-top: 30px;">Crop Performance Analytics</h3>
                        <div id="cropAnalytics" style="height: 300px; background: #f8f9fa; border-radius: 12px; padding: 20px; margin-top: 15px;">
                            <!-- Crop analytics will appear here -->
                        </div>
                    </div>

                    <!-- Export Data Tab -->
                    <div class="tab-content" id="exportTab">
                        <div style="text-align: center; padding: 40px;">
                            <i class="fas fa-database fa-4x" style="color: var(--primary); margin-bottom: 25px;"></i>
                            <h3>Export Farm Data</h3>
                            <p style="color: #666; margin-bottom: 30px; max-width: 600px; margin-left: auto; margin-right: auto;">
                                Export your complete farm data for backup, analysis, or sharing with stakeholders
                            </p>
                            
                            <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                                <button class="btn btn-primary" id="exportAllData">
                                    <i class="fas fa-download"></i> Export All Data (JSON)
                                </button>
                                <button class="btn btn-success" id="exportProjects">
                                    <i class="fas fa-project-diagram"></i> Export Projects
                                </button>
                                <button class="btn btn-info" id="exportFinances">
                                    <i class="fas fa-money-bill-wave"></i> Export Financial Data
                                </button>
                                <button class="btn btn-warning" id="exportInvestments">
                                    <i class="fas fa-user-tie"></i> Export Investments
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- MODALS -->
    <!-- Add Worker Modal -->
    <div id="addWorkerModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('addWorkerModal')">&times;</button>
            <h3><i class="fas fa-user-plus"></i> Add New Worker</h3>
            
            <div class="grid-2">
                <div class="form-group">
                    <label class="form-label">Full Name *</label>
                    <input type="text" class="form-input" id="workerFullName" placeholder="First and last name">
                </div>
                <div class="form-group">
                    <label class="form-label">ID Number</label>
                    <input type="text" class="form-input" id="workerIdNumber" placeholder="Optional">
                </div>
            </div>

            <div class="grid-2">
                <div class="form-group">
                    <label class="form-label">Phone Number</label>
                    <input type="tel" class="form-input" id="workerPhone" placeholder="Optional">
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="workerEmail" placeholder="Optional">
                </div>
            </div>

            <div class="grid-2">
                <div class="form-group">
                    <label class="form-label">Daily Rate *</label>
                    <input type="number" class="form-input" id="workerDailyRate" min="0" step="0.01" value="100">
                    <small style="color: #666;">Full day: R100, Half day: R50</small>
                </div>
                <div class="form-group">
                    <label class="form-label">Date Joined</label>
                    <input type="date" class="form-input" id="workerJoinDate" value="">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Address</label>
                <textarea class="form-textarea" id="workerAddress" placeholder="Worker address"></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">Skills / Specializations</label>
                <textarea class="form-textarea" id="workerSkills" placeholder="List worker skills and specializations"></textarea>
            </div>

            <div style="display: flex; gap: 15px; margin-top: 25px;">
                <button class="btn btn-primary" id="saveWorkerBtn" style="flex: 1;">
                    <i class="fas fa-save"></i> Save Worker
                </button>
                <button class="btn btn-secondary" onclick="closeModal('addWorkerModal')" style="flex: 1;">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Project Modal -->
    <div id="editProjectModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('editProjectModal')">&times;</button>
            <h3><i class="fas fa-edit"></i> Edit Project</h3>
            <input type="hidden" id="editProjectId">
            
            <div class="form-group">
                <label class="form-label">Project Name</label>
                <input type="text" class="form-input" id="editProjectName">
            </div>

            <div class="form-group">
                <label class="form-label">Status</label>
                <select class="form-select" id="editProjectStatus">
                    <option value="active">Active</option>
                    <option value="completed">Completed</option>
                    <option value="delayed">Delayed</option>
                    <option value="cancelled">Cancelled</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Notes</label>
                <textarea class="form-textarea" id="editProjectNotes"></textarea>
            </div>

            <div style="display: flex; gap: 15px; margin-top: 25px;">
                <button class="btn btn-primary" id="updateProjectBtn" style="flex: 1;">
                    <i class="fas fa-save"></i> Update Project
                </button>
                <button class="btn btn-secondary" onclick="closeModal('editProjectModal')" style="flex: 1;">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- View Investment Details Modal -->
    <div id="viewInvestmentModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('viewInvestmentModal')">&times;</button>
            <h3><i class="fas fa-file-invoice-dollar"></i> Investment Details</h3>
            <div id="investmentDetailsContent">
                <!-- Investment details will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        // Mosehleng Farm Management System
        const FarmManager = (function() {
            // Data structure
            let farmData = {
                projects: [],
                investors: [],
                investments: [],
                budgets: [],
                expenses: [],
                workers: [],
                attendance: [],
                activities: [],
                chemicals: [],
                irrigation: [],
                financing: [],
                projectStages: [],
                settings: {
                    fullDayRate: 100,
                    halfDayRate: 50
                }
            };

            // Initialize with sample data
            function initializeSampleData() {
                if (farmData.projects.length === 0) {
                    // Add sample projects
                    farmData.projects = [
                        {
                            id: 1,
                            name: "Summer Cabbage Production",
                            crop: "cabbage",
                            area: 2,
                            startDate: "2024-01-15",
                            harvestDate: "2024-04-30",
                            location: "North Field Block A",
                            description: "Commercial cabbage production for local markets",
                            status: "active"
                        },
                        {
                            id: 2,
                            name: "Organic Carrots",
                            crop: "carrots",
                            area: 1.5,
                            startDate: "2024-02-01",
                            harvestDate: "2024-05-15",
                            location: "East Field",
                            description: "Organic carrot production",
                            status: "active"
                        }
                    ];

                    // Add sample workers
                    farmData.workers = [
                        {
                            id: 1,
                            name: "John Doe",
                            phone: "+27 82 123 4567",
                            dailyRate: 100,
                            joinDate: "2024-01-01",
                            skills: "Planting, harvesting, irrigation"
                        },
                        {
                            id: 2,
                            name: "Jane Smith",
                            phone: "+27 83 987 6543",
                            dailyRate: 100,
                            joinDate: "2024-01-15",
                            skills: "Weeding, packing, quality control"
                        }
                    ];

                    // Add sample investments
                    farmData.investments = [
                        {
                            id: 1,
                            investor: "Trevor Nkgapele",
                            type: "investment",
                            amount: 50000,
                            date: "2024-01-10",
                            paymentMethod: "bank_transfer",
                            reference: "TRV001"
                        },
                        {
                            id: 2,
                            investor: "Sihle Mdutsane",
                            type: "loan",
                            amount: 25000,
                            date: "2024-01-20",
                            paymentMethod: "bank_transfer",
                            reference: "SIH001"
                        }
                    ];
                }
            }

            // Utility functions
            function formatCurrency(amount) {
                return `R ${Number(amount).toLocaleString('en-ZA', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            }

            function formatDate(date) {
                return new Date(date).toLocaleDateString('en-ZA', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            }

            function getToday() {
                return new Date().toISOString().split('T')[0];
            }

            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            function calculateProjectProgress(projectId) {
                const project = farmData.projects.find(p => p.id === projectId);
                if (!project) return 0;

                const stages = farmData.projectStages.filter(s => s.projectId === projectId);
                if (stages.length === 0) return 0;

                const completedStages = stages.filter(s => s.status === 'completed').length;
                return Math.round((completedStages / stages.length) * 100);
            }

            // Initialize
            function init() {
                loadData();
                initializeSampleData();
                setupEventListeners();
                setupDefaultDates();
                loadDashboard();
                updateLastSaveTime();
                loadProjectsDropdowns();
                loadProjectsList();
            }

            function loadData() {
                try {
                    const saved = localStorage.getItem('mosehlengFarmData');
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        farmData = { ...farmData, ...parsed };
                    }
                } catch (e) {
                    console.error('Error loading data:', e);
                }
            }

            function saveData() {
                try {
                    localStorage.setItem('mosehlengFarmData', JSON.stringify(farmData));
                    updateLastSaveTime();
                } catch (e) {
                    console.error('Error saving data:', e);
                }
            }

            function updateLastSaveTime() {
                const now = new Date();
                const timeString = now.toLocaleTimeString('en-ZA', { hour: '2-digit', minute: '2-digit' });
                document.getElementById('lastSave').textContent = `Saved ${timeString}`;
            }

            function setupDefaultDates() {
                const today = getToday();
                const dateInputs = [
                    'projectStartDate', 'projectHarvestDate', 'activityDate',
                    'chemicalDate', 'irrigationDate', 'financingDate',
                    'investmentDate', 'budgetStartDate', 'budgetEndDate',
                    'expenseDate', 'attendanceDate', 'workerJoinDate'
                ];

                dateInputs.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.value = today;
                });

                // Set report dates
                const reportStart = document.getElementById('reportStartDate');
                const reportEnd = document.getElementById('reportEndDate');
                const reportFrom = document.getElementById('reportFromDate');
                const reportTo = document.getElementById('reportToDate');

                if (reportStart) reportStart.value = today;
                if (reportEnd) reportEnd.value = today;
                if (reportFrom) reportFrom.value = today;
                if (reportTo) reportTo.value = today;
            }

            function setupEventListeners() {
                // Navigation
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        showSection(this.dataset.section);
                    });
                });

                // Tabs
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const tabId = this.dataset.tab;
                        const container = this.closest('.tabs-container');
                        showTab(container, tabId);
                    });
                });

                // Project Tracking
                document.getElementById('createProjectBtn')?.addEventListener('click', createProject);
                document.getElementById('updateStageBtn')?.addEventListener('click', updateProjectStage);
                
                // Farm Activities
                document.getElementById('saveActivityBtn')?.addEventListener('click', saveActivity);
                document.getElementById('saveChemicalBtn')?.addEventListener('click', saveChemicalApplication);
                document.getElementById('saveIrrigationBtn')?.addEventListener('click', saveIrrigation);
                
                // Financing
                document.getElementById('saveFinancingBtn')?.addEventListener('click', saveFinancing);
                
                // Investors
                document.getElementById('investorSelect')?.addEventListener('change', function() {
                    document.getElementById('otherInvestorField').style.display = 
                        this.value === 'other' ? 'block' : 'none';
                    updateInvestorInfo();
                });
                document.getElementById('saveInvestmentBtn')?.addEventListener('click', saveInvestment);
                
                // Budget
                document.getElementById('addBudgetItemBtn')?.addEventListener('click', addBudgetItem);
                document.getElementById('removeBudgetItemBtn')?.addEventListener('click', removeBudgetItem);
                document.getElementById('saveBudgetBtn')?.addEventListener('click', saveBudget);
                document.getElementById('saveExpenseBtn')?.addEventListener('click', saveExpense);
                
                // Workers
                document.getElementById('addWorkerBtn')?.addEventListener('click', () => showModal('addWorkerModal'));
                document.getElementById('saveWorkerBtn')?.addEventListener('click', saveWorker);
                document.getElementById('saveAttendanceBtn')?.addEventListener('click', saveAttendance);
                document.getElementById('calculatePayrollBtn')?.addEventListener('click', calculatePayroll);
                document.getElementById('payPeriod')?.addEventListener('change', function() {
                    document.getElementById('customPeriodFields').style.display = 
                        this.value === 'custom' ? 'block' : 'none';
                });
                
                // Reports
                document.getElementById('generatePdfBtn')?.addEventListener('click', generatePdfReport);
                document.getElementById('generateExcelBtn')?.addEventListener('click', generateExcelReport);
                document.getElementById('exportAllData')?.addEventListener('click', () => exportData('all'));
                document.getElementById('exportProjects')?.addEventListener('click', () => exportData('projects'));
                document.getElementById('exportFinances')?.addEventListener('click', () => exportData('finances'));
                document.getElementById('exportInvestments')?.addEventListener('click', () => exportData('investments'));
                
                // Real-time calculations
                document.getElementById('projectArea')?.addEventListener('input', calculateProjectDetails);
                document.getElementById('vegetableCrop')?.addEventListener('change', updateCropDetails);
                
                // Event listeners for filters and searches
                document.getElementById('projectFilter')?.addEventListener('change', loadProjectsList);
                document.getElementById('projectSearch')?.addEventListener('input', loadProjectsList);
                document.getElementById('investmentFilter')?.addEventListener('change', loadInvestmentHistory);
                document.getElementById('investmentHistoryDate')?.addEventListener('change', loadInvestmentHistory);
                
                // Budget item calculations
                document.addEventListener('input', function(e) {
                    if (e.target.classList.contains('budget-quantity') || 
                        e.target.classList.contains('budget-unit-cost')) {
                        updateBudgetItemTotal(e.target);
                    }
                });
            }

            function showSection(sectionId) {
                // Update navigation
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`[data-section="${sectionId}"]`)?.classList.add('active');
                
                // Show selected section
                document.querySelectorAll('.section').forEach(section => {
                    section.classList.remove('active');
                });
                document.getElementById(sectionId)?.classList.add('active');
                
                // Load section data
                loadSectionData(sectionId);
            }

            function showTab(container, tabId) {
                if (!container) return;
                
                // Update tab buttons
                container.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                container.querySelector(`[data-tab="${tabId}"]`)?.classList.add('active');
                
                // Show selected tab
                container.querySelectorAll('.tab-content').forEach(tab => {
                    tab.classList.remove('active');
                });
                container.querySelector(`#${tabId}Tab`)?.classList.add('active');
            }

            function showModal(modalId) {
                document.getElementById(modalId).style.display = 'block';
            }

            function closeModal(modalId) {
                document.getElementById(modalId).style.display = 'none';
            }

            function showNotification(message, type = 'success') {
                const notification = document.createElement('div');
                notification.className = `notification notification-${type}`;
                notification.innerHTML = `<i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'exclamation' : 'info'}-circle"></i> ${message}`;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 3000);
            }

            function loadSectionData(sectionId) {
                switch(sectionId) {
                    case 'dashboard':
                        loadDashboard();
                        break;
                    case 'projectTracking':
                        loadProjectTracking();
                        break;
                    case 'farmActivities':
                        loadFarmActivities();
                        break;
                    case 'financing':
                        loadFinancing();
                        break;
                    case 'investors':
                        loadInvestors();
                        break;
                    case 'budget':
                        loadBudgetSection();
                        break;
                    case 'workers':
                        loadWorkersSection();
                        break;
                    case 'reports':
                        loadReports();
                        break;
                }
            }

            // Dashboard functions
            function loadDashboard() {
                updateDashboardStats();
                loadProjectsProgress();
                loadRecentActivities();
            }

            function updateDashboardStats() {
                const activeProjects = farmData.projects.filter(p => p.status === 'active').length;
                const totalInvestment = farmData.investments.reduce((sum, inv) => sum + inv.amount, 0);
                const workersToday = farmData.attendance
                    .filter(a => a.date === getToday() && a.status !== 'absent')
                    .length;

                document.getElementById('activeProjects').textContent = activeProjects;
                document.getElementById('totalInvestment').textContent = formatCurrency(totalInvestment);
                document.getElementById('workersCount').textContent = workersToday;
            }

            function loadProjectsProgress() {
                const container = document.getElementById('projectsProgress');
                const activeProjects = farmData.projects.filter(p => p.status === 'active');
                
                if (activeProjects.length === 0) {
                    container.innerHTML = '<p style="color: #666; text-align: center;">No active projects</p>';
                    return;
                }

                container.innerHTML = activeProjects.map(project => {
                    const progress = calculateProjectProgress(project.id);
                    return `
                        <div style="margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <strong>${escapeHtml(project.name)}</strong>
                                <span>${progress}%</span>
                            </div>
                            <div class="progress-container">
                                <div class="progress-bar" style="width: ${progress}%"></div>
                            </div>
                            <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">
                                ${project.crop} â¢ ${project.area} ha
                            </div>
                        </div>
                    `;
                }).join('');
            }

            function loadRecentActivities() {
                const container = document.getElementById('recentActivities');
                const recent = [...farmData.activities]
                    .sort((a, b) => new Date(b.date) - new Date(a.date))
                    .slice(0, 10);

                if (recent.length === 0) {
                    container.innerHTML = '<p style="color: #666; text-align: center;">No recent activities</p>';
                    return;
                }

                container.innerHTML = recent.map(activity => {
                    const project = farmData.projects.find(p => p.id === activity.projectId);
                    return `
                        <div style="padding: 15px; border-bottom: 1px solid #eee;">
                            <div style="display: flex; justify-content: space-between;">
                                <div>
                                    <strong>${activity.type.replace('_', ' ')}</strong>
                                    ${project ? `<div style="color: #666; font-size: 0.9rem;">${project.name}</div>` : ''}
                                </div>
                                <span style="color: #666; font-size: 0.9rem;">${formatDate(activity.date)}</span>
                            </div>
                            <div style="margin-top: 5px; font-size: 0.9rem;">${escapeHtml(activity.description)}</div>
                        </div>
                    `;
                }).join('');
            }

            // Project Tracking functions
            function loadProjectTracking() {
                loadProjectsDropdowns();
                loadProjectsList();
            }

            function updateCropDetails() {
                const crop = document.getElementById('vegetableCrop').value;
                const details = document.getElementById('cropSpecifics');
                
                const cropDetails = {
                    cabbage: { duration: '85-120 days', spacing: '50x50 cm', yield: '40-60 tons/ha' },
                    beetroot: { duration: '60-80 days', spacing: '10x30 cm', yield: '20-40 tons/ha' },
                    carrots: { duration: '70-100 days', spacing: '5x30 cm', yield: '30-50 tons/ha' },
                    onions: { duration: '90-150 days', spacing: '10x20 cm', yield: '25-40 tons/ha' },
                    spinach: { duration: '40-50 days', spacing: '15x20 cm', yield: '15-25 tons/ha' },
                    cauliflower: { duration: '80-120 days', spacing: '60x60 cm', yield: '15-25 tons/ha' },
                    broccoli: { duration: '70-100 days', spacing: '60x60 cm', yield: '15-20 tons/ha' },
                    tomatoes: { duration: '90-120 days', spacing: '60x60 cm', yield: '30-60 tons/ha' },
                    turnips: { duration: '45-60 days', spacing: '15x30 cm', yield: '20-35 tons/ha' },
                    lettuce: { duration: '45-70 days', spacing: '25x25 cm', yield: '20-30 tons/ha' },
                    kale: { duration: '55-75 days', spacing: '45x45 cm', yield: '15-25 tons/ha' }
                };

                if (crop && cropDetails[crop]) {
                    const detail = cropDetails[crop];
                    details.innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 15px;">
                            <div>
                                <strong>Growing Duration:</strong>
                                <div style="color: #666;">${detail.duration}</div>
                            </div>
                            <div>
                                <strong>Plant Spacing:</strong>
                                <div style="color: #666;">${detail.spacing}</div>
                            </div>
                            <div>
                                <strong>Expected Yield:</strong>
                                <div style="color: var(--primary); font-weight: bold;">${detail.yield}</div>
                            </div>
                        </div>
                    `;
                } else {
                    details.innerHTML = '';
                }
                
                calculateProjectDetails();
            }

            function calculateProjectDetails() {
                const crop = document.getElementById('vegetableCrop').value;
                const area = parseFloat(document.getElementById('projectArea').value) || 1;
                
                const plantsPerHa = {
                    cabbage: 40000,
                    beetroot: 333333,
                    carrots: 666666,
                    onions: 500000,
                    spinach: 444444,
                    cauliflower: 27777,
                    broccoli: 27777,
                    tomatoes: 27777,
                    turnips: 222222,
                    lettuce: 160000,
                    kale: 49383
                };

                if (crop && plantsPerHa[crop]) {
                    const expectedPlants = Math.round(area * plantsPerHa[crop]);
                    document.getElementById('expectedPlants').value = expectedPlants.toLocaleString();
                }

                updateProjectRequirements();
            }

            function updateProjectRequirements() {
                const crop = document.getElementById('vegetableCrop').value;
                const area = parseFloat(document.getElementById('projectArea').value) || 1;
                const container = document.getElementById('projectRequirements');

                const requirements = {
                    cabbage: `â¢ Seeds: ${Math.round(area * 0.5)} kg<br>â¢ Fertilizer: ${Math.round(area * 600)} kg 2:3:4 + Zn<br>â¢ Labor: ${Math.round(area * 168)} person-days`,
                    beetroot: `â¢ Seeds: ${Math.round(area * 3)} kg<br>â¢ Fertilizer: ${Math.round(area * 400)} kg NPK<br>â¢ Labor: ${Math.round(area * 120)} person-days`,
                    carrots: `â¢ Seeds: ${Math.round(area * 2)} kg<br>â¢ Fertilizer: ${Math.round(area * 350)} kg NPK<br>â¢ Labor: ${Math.round(area * 100)} person-days`
                };

                if (crop && requirements[crop]) {
                    container.innerHTML = requirements[crop];
                } else {
                    container.innerHTML = 'Select a crop to see requirements';
                }
            }

            function createProject() {
                const name = document.getElementById('projectName').value;
                const crop = document.getElementById('vegetableCrop').value;
                const area = parseFloat(document.getElementById('projectArea').value);
                const startDate = document.getElementById('projectStartDate').value;
                const harvestDate = document.getElementById('projectHarvestDate').value;
                const location = document.getElementById('projectLocation').value;
                const description = document.getElementById('projectDescription').value;

                if (!name || !crop || !area || !startDate || !location) {
                    showNotification('Please fill in all required fields', 'error');
                    return;
                }

                const project = {
                    id: Date.now(),
                    name,
                    crop,
                    area,
                    startDate,
                    harvestDate,
                    location,
                    description,
                    status: 'active',
                    created: new Date().toISOString()
                };

                farmData.projects.push(project);
                saveData();
                
                // Create initial stages
                const stages = [
                    { stage: 'soil_preparation', name: 'Soil Preparation', status: 'planned' },
                    { stage: 'seedling_preparation', name: 'Seedling Preparation', status: 'planned' },
                    { stage: 'planting', name: 'Planting', status: 'planned' },
                    { stage: 'irrigation', name: 'Irrigation Setup', status: 'planned' },
                    { stage: 'fertilizer_application', name: 'Fertilizer Application', status: 'planned' },
                    { stage: 'harvesting', name: 'Harvesting', status: 'planned' },
                    { stage: 'marketing', name: 'Marketing & Sales', status: 'planned' }
                ];

                stages.forEach(stage => {
                    farmData.projectStages.push({
                        id: Date.now() + Math.random(),
                        projectId: project.id,
                        ...stage,
                        date: startDate,
                        notes: ''
                    });
                });

                showNotification('Project created successfully!', 'success');
                
                // Reset form
                document.getElementById('projectName').value = '';
                document.getElementById('projectDescription').value = '';
                document.getElementById('projectLocation').value = '';
                
                // Reload data
                loadProjectsDropdowns();
                loadProjectsList();
                loadDashboard();
            }

            function loadProjectsDropdowns() {
                const dropdowns = [
                    'timelineProject', 'activityProject', 'chemicalProject',
                    'irrigationProject', 'financingProject', 'investmentProject',
                    'budgetProject', 'expenseProject', 'attendanceProject',
                    'reportProject', 'trackingBudget'
                ];

                dropdowns.forEach(dropdownId => {
                    const select = document.getElementById(dropdownId);
                    if (!select) return;

                    const currentValue = select.value;
                    select.innerHTML = '<option value="">Select Project</option>';

                    farmData.projects.forEach(project => {
                        const option = document.createElement('option');
                        option.value = project.id;
                        option.textContent = `${project.name} (${project.crop})`;
                        select.appendChild(option);
                    });

                    if (currentValue) select.value = currentValue;
                });

                // Also load workers dropdown
                const workersSelect = document.getElementById('activityWorkers');
                if (workersSelect) {
                    workersSelect.innerHTML = '';
                    farmData.workers.forEach(worker => {
                        const option = document.createElement('option');
                        option.value = worker.id;
                        option.textContent = worker.name;
                        workersSelect.appendChild(option);
                    });
                }
            }

            function loadProjectsList() {
                const container = document.getElementById('projectsList');
                const filter = document.getElementById('projectFilter')?.value || 'all';
                const search = document.getElementById('projectSearch')?.value.toLowerCase() || '';

                let filtered = farmData.projects;

                if (filter !== 'all') {
                    filtered = filtered.filter(p => p.status === filter);
                }

                if (search) {
                    filtered = filtered.filter(p => 
                        p.name.toLowerCase().includes(search) ||
                        p.crop.toLowerCase().includes(search) ||
                        p.location.toLowerCase().includes(search)
                    );
                }

                if (filtered.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666; grid-column: 1 / -1;">
                            <i class="fas fa-project-diagram fa-3x" style="margin-bottom: 20px;"></i>
                            <h4>No projects found</h4>
                            <p>Create a new project to get started</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = filtered.map(project => {
                    const progress = calculateProjectProgress(project.id);
                    const statusClass = project.status === 'active' ? 'status-active' :
                                      project.status === 'completed' ? 'status-completed' :
                                      'status-warning';

                    return `
                        <div class="worker-card">
                            <h4>${escapeHtml(project.name)}</h4>
                            <div style="color: #666; font-size: 0.9rem; margin-bottom: 10px;">
                                ${project.crop} â¢ ${project.area} ha
                            </div>
                            <div class="progress-container">
                                <div class="progress-bar" style="width: ${progress}%"></div>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-top: 10px; font-size: 0.9rem;">
                                <span>${progress}% Complete</span>
                                <span class="status-badge ${statusClass}">${project.status}</span>
                            </div>
                            <div style="margin-top: 15px; display: flex; gap: 10px;">
                                <button class="btn btn-small btn-primary" onclick="FarmManager.editProject(${project.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-small btn-info" onclick="FarmManager.viewProject(${project.id})">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            function editProject(projectId) {
                const project = farmData.projects.find(p => p.id === projectId);
                if (!project) return;

                document.getElementById('editProjectId').value = project.id;
                document.getElementById('editProjectName').value = project.name;
                document.getElementById('editProjectStatus').value = project.status;
                document.getElementById('editProjectNotes').value = project.notes || '';
                
                showModal('editProjectModal');
                
                // Add event listener for update button
                const updateBtn = document.getElementById('updateProjectBtn');
                updateBtn.onclick = function() {
                    const updatedName = document.getElementById('editProjectName').value;
                    const updatedStatus = document.getElementById('editProjectStatus').value;
                    const updatedNotes = document.getElementById('editProjectNotes').value;
                    
                    if (!updatedName) {
                        showNotification('Project name is required', 'error');
                        return;
                    }
                    
                    project.name = updatedName;
                    project.status = updatedStatus;
                    project.notes = updatedNotes;
                    project.updated = new Date().toISOString();
                    
                    saveData();
                    showNotification('Project updated successfully!', 'success');
                    closeModal('editProjectModal');
                    loadProjectsList();
                    loadDashboard();
                };
            }

            function viewProject(projectId) {
                const project = farmData.projects.find(p => p.id === projectId);
                if (!project) return;

                const projectStages = farmData.projectStages.filter(s => s.projectId === projectId);
                const projectActivities = farmData.activities.filter(a => a.projectId === projectId);
                const projectInvestments = farmData.investments.filter(inv => inv.projectId === projectId);
                const projectExpenses = farmData.expenses.filter(exp => exp.projectId === projectId);
                
                const progress = calculateProjectProgress(projectId);
                
                // Create a modal or show in a section
                showNotification(`Viewing project: ${project.name}. Progress: ${progress}%`, 'info');
                
                // For now, just show an alert with basic info
                alert(`Project: ${project.name}\n` +
                      `Crop: ${project.crop}\n` +
                      `Area: ${project.area} ha\n` +
                      `Location: ${project.location}\n` +
                      `Status: ${project.status}\n` +
                      `Progress: ${progress}%\n` +
                      `Stages: ${projectStages.length}\n` +
                      `Activities: ${projectActivities.length}\n` +
                      `Investments: ${projectInvestments.length}\n` +
                      `Expenses: ${projectExpenses.length}`);
            }

            function updateProjectStage() {
                const projectId = document.getElementById('timelineProject').value;
                const stage = document.getElementById('currentStage').value;
                const status = document.getElementById('stageStatus').value;
                const date = document.getElementById('stageDate').value;
                const notes = document.getElementById('stageNotes').value;

                if (!projectId || !stage || !date) {
                    showNotification('Please fill in all required fields', 'error');
                    return;
                }

                const stageName = {
                    'soil_preparation': 'Soil Preparation',
                    'seedling_preparation': 'Seedling Preparation',
                    'planting': 'Planting',
                    'irrigation': 'Irrigation Setup',
                    'fertilizer_application': 'Fertilizer Application',
                    'pest_control': 'Pest Control',
                    'disease_control': 'Disease Control',
                    'weed_control': 'Weed Control',
                    'harvesting': 'Harvesting',
                    'post_harvest': 'Post-Harvest',
                    'marketing': 'Marketing & Sales'
                }[stage] || stage;

                const projectStage = {
                    id: Date.now(),
                    projectId: parseInt(projectId),
                    stage,
                    name: stageName,
                    status,
                    date,
                    notes,
                    updated: new Date().toISOString()
                };

                farmData.projectStages.push(projectStage);
                saveData();
                showNotification('Project stage updated successfully!', 'success');
                
                // Clear form
                document.getElementById('stageNotes').value = '';
                
                // Reload timeline
                loadProjectTimeline();
                loadDashboard();
            }

            function loadProjectTimeline() {
                const projectId = document.getElementById('timelineProject').value;
                const container = document.getElementById('projectTimelineView');

                if (!projectId) {
                    container.innerHTML = '<p style="color: #666; text-align: center;">Select a project to view timeline</p>';
                    return;
                }

                const stages = farmData.projectStages
                    .filter(s => s.projectId === parseInt(projectId))
                    .sort((a, b) => new Date(a.date) - new Date(b.date));

                if (stages.length === 0) {
                    container.innerHTML = '<p style="color: #666; text-align: center;">No stages recorded for this project</p>';
                    return;
                }

                container.innerHTML = stages.map(stage => {
                    const statusClass = stage.status === 'completed' ? 'completed' :
                                      stage.status === 'in_progress' ? 'in-progress' : '';

                    return `
                        <div class="timeline-item ${statusClass}">
                            <div class="timeline-date">${formatDate(stage.date)}</div>
                            <div class="timeline-content">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div>
                                        <strong>${stage.name}</strong>
                                        <div style="color: #666; margin-top: 5px;">${escapeHtml(stage.notes)}</div>
                                    </div>
                                    <span class="status-badge status-${stage.status === 'completed' ? 'completed' : stage.status === 'in_progress' ? 'warning' : 'pending'}">
                                        ${stage.status.replace('_', ' ')}
                                    </span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // Farm Activities functions
            function loadFarmActivities() {
                loadProjectsDropdowns();
                loadTodayActivities();
                loadChemicalHistory();
                loadIrrigationSchedule();
            }

            function saveActivity() {
                const projectId = document.getElementById('activityProject').value;
                const type = document.getElementById('activityType').value;
                const date = document.getElementById('activityDate').value;
                const hours = parseFloat(document.getElementById('activityHours').value) || 0;
                const description = document.getElementById('activityDescription').value;
                const workers = Array.from(document.getElementById('activityWorkers').selectedOptions)
                    .map(option => parseInt(option.value));

                if (!projectId || !description.trim() || !date) {
                    showNotification('Please fill in all required fields', 'error');
                    return;
                }

                const activity = {
                    id: Date.now(),
                    projectId: parseInt(projectId),
                    type,
                    date,
                    hours,
                    description: description.trim(),
                    workers,
                    created: new Date().toISOString()
                };

                farmData.activities.push(activity);
                saveData();
                showNotification('Activity saved successfully!', 'success');
                
                // Clear form
                document.getElementById('activityDescription').value = '';
                document.getElementById('activityHours').value = '8';
                
                // Reload data
                loadTodayActivities();
                loadDashboard();
            }

            function loadTodayActivities() {
                const today = getToday();
                const container = document.getElementById('todayActivities');
                const activities = farmData.activities.filter(a => a.date === today);

                if (activities.length === 0) {
                    container.innerHTML = '<p style="color: #666; text-align: center;">No activities recorded today</p>';
                    return;
                }

                container.innerHTML = activities.map(activity => {
                    const project = farmData.projects.find(p => p.id === activity.projectId);
                    return `
                        <div style="padding: 15px; border-bottom: 1px solid #eee;">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div>
                                    <strong>${activity.type.replace('_', ' ')}</strong>
                                    ${project ? `<div style="color: #666; font-size: 0.9rem;">${project.name}</div>` : ''}
                                    <div style="margin-top: 5px; color: #666;">${escapeHtml(activity.description)}</div>
                                    <div style="font-size: 0.9rem; color: var(--primary); margin-top: 5px;">
                                        ${activity.hours} hours
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            function saveChemicalApplication() {
                const projectId = document.getElementById('chemicalProject').value;
                const type = document.getElementById('chemicalType').value;
                const name = document.getElementById('chemicalName').value;
                const quantity = parseFloat(document.getElementById('chemicalQuantity').value) || 0;
                const unit = document.getElementById('chemicalUnit').value;
                const area = parseFloat(document.getElementById('chemicalArea').value) || 0;
                const date = document.getElementById('chemicalDate').value;
                const nextDate = document.getElementById('chemicalNextDate').value;
                const method = document.getElementById('chemicalMethod').value;
                const notes = document.getElementById('chemicalNotes').value;

                if (!projectId || !name.trim() || !quantity || !date) {
                    showNotification('Please fill in all required fields', 'error');
                    return;
                }

                const chemical = {
                    id: Date.now(),
                    projectId: parseInt(projectId),
                    type,
                    name: name.trim(),
                    quantity,
                    unit,
                    area,
                    date,
                    nextDate,
                    method,
                    notes: notes.trim(),
                    created: new Date().toISOString()
                };

                farmData.chemicals.push(chemical);
                saveData();
                showNotification('Chemical application recorded successfully!', 'success');
                
                // Clear form
                document.getElementById('chemicalName').value = '';
                document.getElementById('chemicalQuantity').value = '';
                document.getElementById('chemicalNotes').value = '';
                
                // Reload data
                loadChemicalHistory();
            }

            function loadChemicalHistory() {
                const container = document.getElementById('chemicalHistory');
                const chemicals = [...farmData.chemicals]
                    .sort((a, b) => new Date(b.date) - new Date(a.date))
                    .slice(0, 20);

                if (chemicals.length === 0) {
                    container.innerHTML = '<p style="color: #666; text-align: center;">No chemical applications recorded</p>';
                    return;
                }

                container.innerHTML = chemicals.map(chemical => {
                    const project = farmData.projects.find(p => p.id === chemical.projectId);
                    return `
                        <div style="padding: 15px; border-bottom: 1px solid #eee;">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div>
                                    <strong>${chemical.name}</strong>
                                    ${project ? `<div style="color: #666; font-size: 0.9rem;">${project.name}</div>` : ''}
                                    <div style="color: #666; font-size: 0.9rem; margin-top: 5px;">
                                        ${chemical.quantity} ${chemical.unit} â¢ ${chemical.type}
                                    </div>
                                    <div style="font-size: 0.8rem; color: #666; margin-top: 5px;">
                                        ${formatDate(chemical.date)} â¢ ${chemical.method}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            function saveIrrigation() {
                const projectId = document.getElementById('irrigationProject').value;
                const date = document.getElementById('irrigationDate').value;
                const time = document.getElementById('irrigationTime').value;
                const duration = parseFloat(document.getElementById('irrigationDuration').value) || 0;
                const water = parseFloat(document.getElementById('irrigationWater').value) || 0;
                const area = parseFloat(document.getElementById('irrigationArea').value) || 0;
                const method = document.getElementById('irrigationMethod').value;
                const moisture = document.getElementById('soilMoisture').value;
                const notes = document.getElementById('irrigationNotes').value;

                if (!projectId || !date) {
                    showNotification('Please fill in all required fields', 'error');
                    return;
                }

                const irrigation = {
                    id: Date.now(),
                    projectId: parseInt(projectId),
                    date,
                    time,
                    duration,
                    water,
                    area,
                    method,
                    moisture,
                    notes: notes.trim(),
                    created: new Date().toISOString()
                };

                farmData.irrigation.push(irrigation);
                saveData();
                showNotification('Irrigation recorded successfully!', 'success');
                
                // Clear form
                document.getElementById('irrigationNotes').value = '';
                document.getElementById('irrigationWater').value = '';
                document.getElementById('irrigationDuration').value = '';
                
                // Reload data
                loadIrrigationSchedule();
            }

            function loadIrrigationSchedule() {
                const container = document.getElementById('irrigationSchedule');
                const irrigations = [...farmData.irrigation]
                    .sort((a, b) => new Date(b.date) - new Date(a.date))
                    .slice(0, 15);

                if (irrigations.length === 0) {
                    container.innerHTML = '<p style="color: #666; text-align: center;">No irrigation records</p>';
                    return;
                }

                container.innerHTML = irrigations.map(irrigation => {
                    const project = farmData.projects.find(p => p.id === irrigation.projectId);
                    return `
                        <div style="padding: 15px; border-bottom: 1px solid #eee;">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div>
                                    <strong>${irrigation.method} Irrigation</strong>
                                    ${project ? `<div style="color: #666; font-size: 0.9rem;">${project.name}</div>` : ''}
                                    <div style="color: #666; font-size: 0.9rem; margin-top: 5px;">
                                        ${irrigation.water} mÂ³ â¢ ${irrigation.duration} hours
                                    </div>
                                    <div style="font-size: 0.8rem; color: #666; margin-top: 5px;">
                                        ${formatDate(irrigation.date)} â¢ Soil: ${irrigation.moisture}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // Financing functions
            function loadFinancing() {
                updateFinancingStats();
                loadRecentFinancing();
            }

            function toggleFinancingFields() {
                const type = document.getElementById('financingType').value;
                const interestField = document.getElementById('interestField');
                const termsField = document.getElementById('termsField');
                const sourceField = document.getElementById('sourceField');

                if (type === 'loan') {
                    interestField.style.display = 'block';
                    termsField.style.display = 'block';
                    sourceField.querySelector('label').textContent = 'Lender *';
                } else if (type === 'grant') {
                    interestField.style.display = 'none';
                    termsField.style.display = 'block';
                    sourceField.querySelector('label').textContent = 'Granting Organization *';
                } else if (type === 'investment') {
                    interestField.style.display = 'block';
                    termsField.style.display = 'block';
                    sourceField.querySelector('label').textContent = 'Investor *';
                } else {
                    interestField.style.display = 'none';
                    termsField.style.display = 'none';
                    sourceField.querySelector('label').textContent = 'Source';
                }
            }

            function saveFinancing() {
                const type = document.getElementById('financingType').value;
                const projectId = document.getElementById('financingProject').value;
                const amount = parseFloat(document.getElementById('financingAmount').value);
                const date = document.getElementById('financingDate').value;
                const source = document.getElementById('financingSource').value;
                const interest = parseFloat(document.getElementById('financingInterest').value) || 0;
                const terms = document.getElementById('financingTerms').value;
                const purpose = document.getElementById('financingPurpose').value;

                if (!type || !amount || !date) {
                    showNotification('Please fill in all required fields', 'error');
                    return;
                }

                const financing = {
                    id: Date.now(),
                    type,
                    projectId: projectId || null,
                    amount,
                    date,
                    source: source.trim(),
                    interest,
                    terms: terms.trim(),
                    purpose: purpose.trim(),
                    created: new Date().toISOString()
                };

                farmData.financing.push(financing);
                saveData();
                showNotification('Financing recorded successfully!', 'success');
                
                // Clear form
                document.getElementById('financingAmount').value = '';
                document.getElementById('financingSource').value = '';
                document.getElementById('financingTerms').value = '';
                document.getElementById('financingPurpose').value = '';
                
                // Reload data
                updateFinancingStats();
                loadRecentFinancing();
            }

            function updateFinancingStats() {
                const totalLoans = farmData.financing
                    .filter(f => f.type === 'loan')
                    .reduce((sum, f) => sum + f.amount, 0);
                
                const totalGrants = farmData.financing
                    .filter(f => f.type === 'grant')
                    .reduce((sum, f) => sum + f.amount, 0);
                
                const totalBudget = farmData.budgets.reduce((sum, b) => sum + b.total, 0);
                const totalUsed = farmData.expenses.reduce((sum, e) => sum + e.amount, 0);
                const utilization = totalBudget > 0 ? Math.round((totalUsed / totalBudget) * 100) : 0;

                document.getElementById('totalLoans').textContent = formatCurrency(totalLoans);
                document.getElementById('totalGrants').textContent = formatCurrency(totalGrants);
                document.getElementById('financingUtilization').textContent = `${utilization}%`;
            }

            function loadRecentFinancing() {
                const container = document.getElementById('recentFinancing');
                const recent = [...farmData.financing]
                    .sort((a, b) => new Date(b.date) - new Date(a.date))
                    .slice(0, 10);

                if (recent.length === 0) {
                    container.innerHTML = '<p style="color: #666; text-align: center;">No financing records</p>';
                    return;
                }

                container.innerHTML = recent.map(finance => {
                    const project = finance.projectId ? 
                        farmData.projects.find(p => p.id === finance.projectId) : null;
                    
                    const typeClass = finance.type === 'loan' ? 'status-warning' :
                                    finance.type === 'grant' ? 'status-success' :
                                    finance.type === 'investment' ? 'status-info' : 'status-active';

                    return `
                        <div style="padding: 15px; border-bottom: 1px solid #eee;">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <span class="status-badge ${typeClass}">${finance.type}</span>
                                        <strong style="color: var(--primary);">${formatCurrency(finance.amount)}</strong>
                                    </div>
                                    ${project ? `<div style="color: #666; font-size: 0.9rem; margin-top: 5px;">${project.name}</div>` : ''}
                                    <div style="color: #666; font-size: 0.9rem; margin-top: 5px;">
                                        ${finance.source}
                                    </div>
                                    <div style="font-size: 0.8rem; color: #666; margin-top: 5px;">
                                        ${formatDate(finance.date)}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // Investors functions
            function loadInvestors() {
                loadInvestorPortfolio();
                loadInvestmentHistory();
                updateInvestorInfo();
            }

            function updateInvestorInfo() {
                const investor = document.getElementById('investorSelect').value;
                const container = document.getElementById('investorDetails');

                if (!investor || investor === 'other') {
                    container.innerHTML = '<p>Select an investor to view details</p>';
                    return;
                }

                const investments = farmData.investments.filter(inv => inv.investor === investor);
                const totalInvested = investments.reduce((sum, inv) => sum + inv.amount, 0);
                const lastInvestment = investments.length > 0 ? 
                    formatDate(Math.max(...investments.map(inv => new Date(inv.date)))) : 'None';

                container.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 15px;">
                        <div>
                            <strong>Total Invested:</strong>
                            <div style="color: var(--primary); font-weight: bold;">${formatCurrency(totalInvested)}</div>
                        </div>
                        <div>
                            <strong>Investments:</strong>
                            <div>${investments.length}</div>
                        </div>
                        <div>
                            <strong>Last Investment:</strong>
                            <div>${lastInvestment}</div>
                        </div>
                        <div>
                            <strong>Average Investment:</strong>
                            <div>${formatCurrency(investments.length > 0 ? totalInvested / investments.length : 0)}</div>
                        </div>
                    </div>
                `;
            }

            function saveInvestment() {
                let investor = document.getElementById('investorSelect').value;
                if (investor === 'other') {
                    investor = document.getElementById('otherInvestorName').value.trim();
                    if (!investor) {
                        showNotification('Please enter investor name', 'error');
                        return;
                    }
                }

                const type = document.getElementById('investmentType').value;
                const amount = parseFloat(document.getElementById('investmentAmount').value);
                const date = document.getElementById('investmentDate').value;
                const projectId = document.getElementById('investmentProject').value;
                const paymentMethod = document.getElementById('paymentMethod').value;
                const reference = document.getElementById('investmentReference').value;
                const terms = document.getElementById('investmentTerms').value;
                const notes = document.getElementById('investmentNotes').value;

                if (!investor || !amount || !date) {
                    showNotification('Please fill in all required fields', 'error');
                    return;
                }

                const investment = {
                    id: Date.now(),
                    investor,
                    type,
                    amount,
                    date,
                    projectId: projectId || null,
                    paymentMethod,
                    reference: reference.trim(),
                    terms: terms.trim(),
                    notes: notes.trim(),
                    created: new Date().toISOString()
                };

                farmData.investments.push(investment);
                saveData();
                showNotification('Investment recorded successfully!', 'success');
                
                // Clear form
                document.getElementById('investmentAmount').value = '';
                document.getElementById('investmentReference').value = '';
                document.getElementById('investmentTerms').value = '';
                document.getElementById('investmentNotes').value = '';
                document.getElementById('otherInvestorName').value = '';
                
                // Reload data
                loadInvestorPortfolio();
                loadInvestmentHistory();
                loadRecentInvestments();
                updateDashboardStats();
            }

            function loadInvestorPortfolio() {
                const container = document.getElementById('investorPortfolioGrid');
                const investors = [...new Set(farmData.investments.map(inv => inv.investor))];
                
                if (investors.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666; grid-column: 1 / -1;">
                            <i class="fas fa-user-tie fa-3x" style="margin-bottom: 20px;"></i>
                            <h4>No investors yet</h4>
                            <p>Record investments to build investor portfolio</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = investors.map(investor => {
                    const investments = farmData.investments.filter(inv => inv.investor === investor);
                    const total = investments.reduce((sum, inv) => sum + inv.amount, 0);
                    const lastInvestment = investments.length > 0 ? 
                        formatDate(Math.max(...investments.map(inv => new Date(inv.date)))) : 'Never';

                    return `
                        <div class="worker-card">
                            <h4>${escapeHtml(investor)}</h4>
                            <div style="font-size: 1.8rem; font-weight: bold; color: var(--primary); margin: 15px 0;">
                                ${formatCurrency(total)}
                            </div>
                            <div style="color: #666; font-size: 0.9rem;">
                                <div>Investments: ${investments.length}</div>
                                <div>Last: ${lastInvestment}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            function loadInvestmentHistory() {
                const filter = document.getElementById('investmentFilter')?.value || 'all';
                const dateFilter = document.getElementById('investmentHistoryDate')?.value;
                let container = document.getElementById('investmentHistoryTable');

                if (!container) {
                    container = document.createElement('tbody');
                    container.id = 'investmentHistoryTable';
                    document.querySelector('#investmentHistoryTab table')?.appendChild(container);
                }

                let investments = [...farmData.investments]
                    .sort((a, b) => new Date(b.date) - new Date(a.date));

                if (filter !== 'all') {
                    investments = investments.filter(inv => 
                        filter === 'other' ? 
                        !['Trevor Nkgapele', 'Sihle Mdutsane', 'Moses Mkhabela', 'France Gafane'].includes(inv.investor) :
                        inv.investor === filter
                    );
                }

                if (dateFilter) {
                    investments = investments.filter(inv => inv.date === dateFilter);
                }

                if (investments.length === 0) {
                    container.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 20px; color: #666;">
                                No investments found
                            </td>
                        </tr>
                    `;
                    return;
                }

                container.innerHTML = investments.map(investment => {
                    const project = investment.projectId ? 
                        farmData.projects.find(p => p.id === investment.projectId) : null;

                    return `
                        <tr>
                            <td>${formatDate(investment.date)}</td>
                            <td>${escapeHtml(investment.investor)}</td>
                            <td>${investment.type}</td>
                            <td>${formatCurrency(investment.amount)}</td>
                            <td>${project ? escapeHtml(project.name) : 'General'}</td>
                            <td>${investment.reference || 'N/A'}</td>
                            <td>
                                <button class="btn btn-icon btn-small" onclick="FarmManager.viewInvestment(${investment.id})">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            function loadRecentInvestments() {
                const container = document.getElementById('recentInvestments');
                const recent = [...farmData.investments]
                    .sort((a, b) => new Date(b.date) - new Date(a.date))
                    .slice(0, 10);

                if (recent.length === 0) {
                    container.innerHTML = '<p style="color: #666; text-align: center;">No recent investments</p>';
                    return;
                }

                container.innerHTML = recent.map(investment => {
                    return `
                        <div style="padding: 15px; border-bottom: 1px solid #eee;">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div>
                                    <strong>${escapeHtml(investment.investor)}</strong>
                                    <div style="color: var(--primary); font-weight: bold; margin-top: 5px;">
                                        ${formatCurrency(investment.amount)}
                                    </div>
                                    <div style="color: #666; font-size: 0.9rem; margin-top: 5px;">
                                        ${investment.type} â¢ ${formatDate(investment.date)}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            function viewInvestment(investmentId) {
                const investment = farmData.investments.find(inv => inv.id === investmentId);
                if (!investment) return;

                const project = investment.projectId ? 
                    farmData.projects.find(p => p.id === investment.projectId) : null;

                const content = document.getElementById('investmentDetailsContent');
                content.innerHTML = `
                    <div style="display: grid; gap: 20px;">
                        <div>
                            <h4>Investment Details</h4>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                                    <div>
                                        <strong>Investor:</strong>
                                        <div>${escapeHtml(investment.investor)}</div>
                                    </div>
                                    <div>
                                        <strong>Amount:</strong>
                                        <div style="color: var(--primary); font-weight: bold;">${formatCurrency(investment.amount)}</div>
                                    </div>
                                    <div>
                                        <strong>Type:</strong>
                                        <div>${investment.type}</div>
                                    </div>
                                    <div>
                                        <strong>Date:</strong>
                                        <div>${formatDate(investment.date)}</div>
                                    </div>
                                    <div>
                                        <strong>Payment Method:</strong>
                                        <div>${investment.paymentMethod}</div>
                                    </div>
                                    <div>
                                        <strong>Reference:</strong>
                                        <div>${investment.reference || 'N/A'}</div>
                                    </div>
                                    <div>
                                        <strong>Project:</strong>
                                        <div>${project ? escapeHtml(project.name) : 'General'}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        ${investment.terms ? `
                        <div>
                            <h4>Terms & Conditions</h4>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                                ${escapeHtml(investment.terms)}
                            </div>
                        </div>
                        ` : ''}
                        
                        ${investment.notes ? `
                        <div>
                            <h4>Notes</h4>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                                ${escapeHtml(investment.notes)}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                `;

                showModal('viewInvestmentModal');
            }

            // Budget functions
            function loadBudgetSection() {
                loadBudgetPreview();
                loadRecentExpenses();
                updateBudgetItemTotals();
            }

            function addBudgetItem() {
                const container = document.getElementById('budgetItemsContainer');
                const newItem = document.createElement('div');
                newItem.className = 'budget-item';
                newItem.style.marginBottom = '15px';
                newItem.style.padding = '15px';
                newItem.style.border = '1px dashed #ddd';
                newItem.style.borderRadius = '8px';

                newItem.innerHTML = `
                    <div class="grid-4">
                        <div class="form-group">
                            <label class="form-label">Category</label>
                            <select class="form-select budget-category">
                                <option value="seeds">Seeds/Seedlings</option>
                                <option value="fertilizer">Fertilizer</option>
                                <option value="pesticides">Pesticides</option>
                                <option value="labor">Labor</option>
                                <option value="irrigation">Irrigation</option>
                                <option value="equipment">Equipment</option>
                                <option value="fuel">Fuel</option>
                                <option value="transport">Transport</option>
                                <option value="packaging">Packaging</option>
                                <option value="marketing">Marketing</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Item Description</label>
                            <input type="text" class="form-input budget-description" placeholder="Item description">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Quantity</label>
                            <input type="number" class="form-input budget-quantity" step="0.01" min="0" value="1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Unit Cost (R)</label>
                            <input type="number" class="form-input budget-unit-cost" step="0.01" min="0" value="0">
                        </div>
                    </div>
                    <div class="grid-2">
                        <div class="form-group">
                            <label class="form-label">Unit</label>
                            <select class="form-select budget-unit">
                                <option value="kg">kg</option>
                                <option value="litre">Litre</option>
                                <option value="bag">Bag</option>
                                <option value="packet">Packet</option>
                                <option value="person-day">Person-day</option>
                                <option value="hectare">Hectare</option>
                                <option value="unit">Unit</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Total Cost (R)</label>
                            <input type="number" class="form-input budget-total" readonly value="0">
                        </div>
                    </div>
                `;

                container.appendChild(newItem);
                updateBudgetItemTotals();
            }

            function removeBudgetItem() {
                const items = document.querySelectorAll('.budget-item');
                if (items.length > 1) {
                    items[items.length - 1].remove();
                    updateBudgetItemTotals();
                }
            }

            function updateBudgetItemTotal(input) {
                const item = input.closest('.budget-item');
                const quantity = parseFloat(item.querySelector('.budget-quantity').value) || 0;
                const unitCost = parseFloat(item.querySelector('.budget-unit-cost').value) || 0;
                const total = quantity * unitCost;
                item.querySelector('.budget-total').value = total.toFixed(2);
                updateBudgetItemTotals();
            }

            function updateBudgetItemTotals() {
                const items = document.querySelectorAll('.budget-item');
                let total = 0;
                
                items.forEach(item => {
                    const itemTotal = parseFloat(item.querySelector('.budget-total').value) || 0;
                    total += itemTotal;
                });
                
                document.getElementById('totalBudget').value = total.toFixed(2);
                updateBudgetPreview();
            }

            function updateBudgetPreview() {
                const container = document.getElementById('budgetPreview');
                const items = document.querySelectorAll('.budget-item');
                
                if (items.length === 0) {
                    container.innerHTML = '<p style="color: #666; text-align: center;">No budget items added</p>';
                    return;
                }

                let html = '<h4>Budget Items</h4>';
                items.forEach((item, index) => {
                    const category = item.querySelector('.budget-category').value;
                    const description = item.querySelector('.budget-description').value || 'No description';
                    const quantity = item.querySelector('.budget-quantity').value;
                    const unit = item.querySelector('.budget-unit').value;
                    const unitCost = item.querySelector('.budget-unit-cost').value;
                    const total = item.querySelector('.budget-total').value;

                    html += `
                        <div style="padding: 10px; border-bottom: 1px solid #eee; font-size: 0.9rem;">
                            <div style="display: flex; justify-content: space-between;">
                                <strong>${index + 1}. ${category}</strong>
                                <span>${formatCurrency(total)}</span>
                            </div>
                            <div style="color: #666;">${description}</div>
                            <div style="color: #666; font-size: 0.8rem;">
                                ${quantity} ${unit} Ã ${formatCurrency(unitCost)}
                            </div>
                        </div>
                    `;
                });

                const total = document.getElementById('totalBudget').value;
                html += `
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid var(--primary); font-weight: bold;">
                        <div style="display: flex; justify-content: space-between;">
                            <span>Total Budget:</span>
                            <span>${formatCurrency(total)}</span>
                        </div>
                    </div>
                `;

                container.innerHTML = html;
            }

            function saveBudget() {
                const projectId = document.getElementById('budgetProject').value;
                const name = document.getElementById('budgetName').value;
                const startDate = document.getElementById('budgetStartDate').value;
                const endDate = document.getElementById('budgetEndDate').value;
                const items = [];

                document.querySelectorAll('.budget-item').forEach(item => {
                    const category = item.querySelector('.budget-category').value;
                    const description = item.querySelector('.budget-description').value;
                    const quantity = parseFloat(item.querySelector('.budget-quantity').value) || 0;
                    const unit = item.querySelector('.budget-unit').value;
                    const unitCost = parseFloat(item.querySelector('.budget-unit-cost').value) || 0;
                    const total = parseFloat(item.querySelector('.budget-total').value) || 0;

                    if (description) {
                        items.push({
                            category,
                            description,
                            quantity,
                            unit,
                            unitCost,
                            total
                        });
                    }
                });

                if (!projectId || !name || items.length === 0) {
                    showNotification('Please fill in all required fields and add budget items', 'error');
                    return;
                }

                const total = items.reduce((sum, item) => sum + item.total, 0);

                const budget = {
                    id: Date.now(),
                    projectId: parseInt(projectId),
                    name,
                    startDate,
                    endDate,
                    items,
                    total,
                    created: new Date().toISOString()
                };

                farmData.budgets.push(budget);
                saveData();
                showNotification('Budget saved successfully!', 'success');
                
                // Clear form
                document.getElementById('budgetName').value = '';
                const container = document.getElementById('budgetItemsContainer');
                container.innerHTML = container.firstElementChild.outerHTML;
                updateBudgetItemTotals();
            }

            function saveExpense() {
                const projectId = document.getElementById('expenseProject').value;
                const category = document.getElementById('expenseCategory').value;
                const amount = parseFloat(document.getElementById('expenseAmount').value);
                const date = document.getElementById('expenseDate').value;
                const description = document.getElementById('expenseDescription').value;
                const receipt = document.getElementById('expenseReceipt').value;

                if (!projectId || !amount || !date || !description.trim()) {
                    showNotification('Please fill in all required fields', 'error');
                    return;
                }

                const expense = {
                    id: Date.now(),
                    projectId: parseInt(projectId),
                    category,
                    amount,
                    date,
                    description: description.trim(),
                    receipt: receipt.trim(),
                    created: new Date().toISOString()
                };

                farmData.expenses.push(expense);
                saveData();
                showNotification('Expense recorded successfully!', 'success');
                
                // Clear form
                document.getElementById('expenseAmount').value = '';
                document.getElementById('expenseDescription').value = '';
                document.getElementById('expenseReceipt').value = '';
                
                // Reload data
                loadRecentExpenses();
                updateFinancingStats();
            }

            function loadRecentExpenses() {
                const container = document.getElementById('recentExpenses');
                const recent = [...farmData.expenses]
                    .sort((a, b) => new Date(b.date) - new Date(a.date))
                    .slice(0, 15);

                if (recent.length === 0) {
                    container.innerHTML = '<p style="color: #666; text-align: center;">No expenses recorded</p>';
                    return;
                }

                container.innerHTML = recent.map(expense => {
                    const project = farmData.projects.find(p => p.id === expense.projectId);
                    return `
                        <div style="padding: 15px; border-bottom: 1px solid #eee;">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div>
                                    <div style="color: var(--danger); font-weight: bold;">
                                        ${formatCurrency(expense.amount)}
                                    </div>
                                    <div style="color: #666; font-size: 0.9rem; margin-top: 5px;">
                                        ${expense.category}
                                    </div>
                                    <div style="margin-top: 5px;">${escapeHtml(expense.description)}</div>
                                    ${project ? `<div style="color: #666; font-size: 0.9rem; margin-top: 5px;">${project.name}</div>` : ''}
                                    <div style="font-size: 0.8rem; color: #666; margin-top: 5px;">
                                        ${formatDate(expense.date)}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // Workers & Payroll functions
            function loadWorkersSection() {
                loadWorkersDatabase();
                loadAttendanceList();
                loadAttendanceSummary();
            }

            function saveWorker() {
                const name = document.getElementById('workerFullName').value;
                const idNumber = document.getElementById('workerIdNumber').value;
                const phone = document.getElementById('workerPhone').value;
                const email = document.getElementById('workerEmail').value;
                const dailyRate = parseFloat(document.getElementById('workerDailyRate').value);
                const joinDate = document.getElementById('workerJoinDate').value;
                const address = document.getElementById('workerAddress').value;
                const skills = document.getElementById('workerSkills').value;

                if (!name || !dailyRate) {
                    showNotification('Please fill in all required fields', 'error');
                    return;
                }

                const worker = {
                    id: Date.now(),
                    name: name.trim(),
                    idNumber: idNumber.trim(),
                    phone: phone.trim(),
                    email: email.trim(),
                    dailyRate,
                    joinDate,
                    address: address.trim(),
                    skills: skills.trim(),
                    status: 'active',
                    created: new Date().toISOString()
                };

                farmData.workers.push(worker);
                saveData();
                showNotification('Worker added successfully!', 'success');
                closeModal('addWorkerModal');
                
                // Reload data
                loadWorkersDatabase();
                loadAttendanceList();
                loadWorkersSection();
            }

            function loadWorkersDatabase() {
                const container = document.getElementById('workersDatabase');
                
                if (farmData.workers.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666; grid-column: 1 / -1;">
                            <i class="fas fa-users fa-3x" style="margin-bottom: 20px;"></i>
                            <h4>No workers added</h4>
                            <p>Add workers to manage your workforce</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = farmData.workers.map(worker => {
                    return `
                        <div class="worker-card">
                            <h4>${escapeHtml(worker.name)}</h4>
                            <div style="color: #666; font-size: 0.9rem; margin-bottom: 10px;">
                                ${worker.phone || 'No phone'}
                            </div>
                            <div style="font-weight: bold; color: var(--primary); margin-bottom: 10px;">
                                ${formatCurrency(worker.dailyRate)}/day
                            </div>
                            <div style="font-size: 0.8rem; color: #666;">
                                ${worker.skills ? escapeHtml(worker.skills.substring(0, 50)) + (worker.skills.length > 50 ? '...' : '') : 'No skills specified'}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            function loadAttendanceList() {
                const container = document.getElementById('attendanceList');
                const date = document.getElementById('attendanceDate').value || getToday();
                
                if (farmData.workers.length === 0) {
                    container.innerHTML = '<p style="color: #666; text-align: center;">No workers added</p>';
                    return;
                }

                let html = '';
                farmData.workers.forEach(worker => {
                    const todayAttendance = farmData.attendance.find(a => 
                        a.workerId === worker.id && a.date === date
                    );

                    html += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #eee;">
                            <div>
                                <strong>${escapeHtml(worker.name)}</strong>
                                <div style="color: #666; font-size: 0.9rem;">${formatCurrency(worker.dailyRate)}/day</div>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <select class="form-select worker-attendance" data-worker-id="${worker.id}" style="width: 120px;">
                                    <option value="full_day" ${todayAttendance?.status === 'full_day' ? 'selected' : ''}>Full Day</option>
                                    <option value="half_day" ${todayAttendance?.status === 'half_day' ? 'selected' : ''}>Half Day</option>
                                    <option value="absent" ${todayAttendance?.status === 'absent' ? 'selected' : ''}>Absent</option>
                                </select>
                                <input type="time" class="form-input" placeholder="Time In" 
                                       value="${todayAttendance?.timeIn || ''}" 
                                       style="width: 100px;"
                                       data-worker-id="${worker.id}"
                                       onchange="FarmManager.updateAttendanceTime(${worker.id}, 'timeIn', this.value)">
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = html;
            }

            function updateAttendanceTime(workerId, field, value) {
                const date = document.getElementById('attendanceDate').value || getToday();
                let attendance = farmData.attendance.find(a => a.workerId === workerId && a.date === date);
                
                if (!attendance) {
                    attendance = {
                        id: Date.now(),
                        workerId,
                        date,
                        status: 'full_day',
                        timeIn: '',
                        timeOut: ''
                    };
                    farmData.attendance.push(attendance);
                }
                
                attendance[field] = value;
                saveData();
            }

            function saveAttendance() {
                const date = document.getElementById('attendanceDate').value || getToday();
                const projectId = document.getElementById('attendanceProject').value;
                
                document.querySelectorAll('.worker-attendance').forEach(select => {
                    const workerId = parseInt(select.dataset.workerId);
                    const status = select.value;
                    
                    let attendance = farmData.attendance.find(a => a.workerId === workerId && a.date === date);
                    if (!attendance) {
                        attendance = {
                            id: Date.now(),
                            workerId,
                            date,
                            status,
                            projectId: projectId || null,
                            created: new Date().toISOString()
                        };
                        farmData.attendance.push(attendance);
                    } else {
                        attendance.status = status;
                        attendance.projectId = projectId || null;
                    }
                });
                
                saveData();
                showNotification('Attendance saved successfully!', 'success');
                loadAttendanceSummary();
                loadDashboard();
            }

            function loadAttendanceSummary() {
                const date = document.getElementById('attendanceDate').value || getToday();
                const container = document.getElementById('attendanceSummary');
                
                const todayAttendance = farmData.attendance.filter(a => a.date === date);
                const fullDay = todayAttendance.filter(a => a.status === 'full_day').length;
                const halfDay = todayAttendance.filter(a => a.status === 'half_day').length;
                const absent = todayAttendance.filter(a => a.status === 'absent').length;
                
                const totalCost = (fullDay * farmData.settings.fullDayRate) + 
                                 (halfDay * farmData.settings.halfDayRate);
                
                container.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold; color: var(--success);">${fullDay}</div>
                            <div style="color: #666;">Full Day</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold; color: var(--warning);">${halfDay}</div>
                            <div style="color: #666;">Half Day</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold; color: var(--danger);">${absent}</div>
                            <div style="color: #666;">Absent</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold; color: var(--primary);">${formatCurrency(totalCost)}</div>
                            <div style="color: #666;">Daily Cost</div>
                        </div>
                    </div>
                `;
            }

            function calculatePayroll() {
                const period = document.getElementById('payPeriod').value;
                let startDate, endDate;
                
                if (period === 'custom') {
                    startDate = document.getElementById('payrollStartDate').value;
                    endDate = document.getElementById('payrollEndDate').value;
                } else {
                    endDate = getToday();
                    const end = new Date(endDate);
                    if (period === 'weekly') {
                        start = new Date(end);
                        start.setDate(start.getDate() - 7);
                    } else { // monthly
                        start = new Date(end);
                        start.setDate(start.getDate() - 30);
                    }
                    startDate = start.toISOString().split('T')[0];
                }
                
                if (!startDate || !endDate) {
                    showNotification('Please select dates', 'error');
                    return;
                }
                
                const payroll = [];
                let totalCost = 0;
                
                farmData.workers.forEach(worker => {
                    const workerAttendance = farmData.attendance.filter(a => 
                        a.workerId === worker.id && 
                        a.date >= startDate && 
                        a.date <= endDate
                    );
                    
                    const fullDays = workerAttendance.filter(a => a.status === 'full_day').length;
                    const halfDays = workerAttendance.filter(a => a.status === 'half_day').length;
                    const workerCost = (fullDays * worker.dailyRate) + (halfDays * (worker.dailyRate / 2));
                    
                    payroll.push({
                        worker: worker.name,
                        fullDays,
                        halfDays,
                        rate: worker.dailyRate,
                        cost: workerCost
                    });
                    
                    totalCost += workerCost;
                });
                
                displayPayrollSummary(payroll, totalCost, startDate, endDate);
            }

            function displayPayrollSummary(payroll, totalCost, startDate, endDate) {
                const container = document.getElementById('payrollSummary');
                
                let html = `
                    <h4>Payroll Summary (${formatDate(startDate)} to ${formatDate(endDate)})</h4>
                    <div style="margin-top: 20px;">
                `;
                
                payroll.forEach(item => {
                    html += `
                        <div style="padding: 10px; border-bottom: 1px solid #eee;">
                            <div style="display: flex; justify-content: space-between;">
                                <div>
                                    <strong>${item.worker}</strong>
                                    <div style="color: #666; font-size: 0.9rem;">
                                        ${item.fullDays} full, ${item.halfDays} half days Ã ${formatCurrency(item.rate)}
                                    </div>
                                </div>
                                <div style="font-weight: bold;">${formatCurrency(item.cost)}</div>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid var(--primary);">
                            <div style="display: flex; justify-content: space-between; font-size: 1.2rem; font-weight: bold;">
                                <span>Total Payroll:</span>
                                <span>${formatCurrency(totalCost)}</span>
                            </div>
                        </div>
                    </div>
                `;
                
                container.innerHTML = html;
            }

            function loadBudgetTracking() {
                const budgetId = document.getElementById('trackingBudget').value;
                if (!budgetId) return;
                
                const budget = farmData.budgets.find(b => b.id === parseInt(budgetId));
                if (!budget) return;
                
                const container = document.getElementById('budgetTrackingSummary');
                const project = farmData.projects.find(p => p.id === budget.projectId);
                const expenses = farmData.expenses.filter(exp => exp.projectId === budget.projectId);
                const totalSpent = expenses.reduce((sum, exp) => sum + exp.amount, 0);
                const remaining = budget.total - totalSpent;
                const utilization = budget.total > 0 ? Math.round((totalSpent / budget.total) * 100) : 0;
                
                container.innerHTML = `
                    <h4>${budget.name}</h4>
                    <div style="margin-top: 20px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span>Budget:</span>
                            <span style="font-weight: bold;">${formatCurrency(budget.total)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span>Spent:</span>
                            <span style="color: var(--danger); font-weight: bold;">${formatCurrency(totalSpent)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span>Remaining:</span>
                            <span style="color: ${remaining >= 0 ? 'var(--success)' : 'var(--danger)'}; font-weight: bold;">
                                ${formatCurrency(remaining)}
                            </span>
                        </div>
                        <div style="margin-top: 15px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span>Utilization:</span>
                                <span>${utilization}%</span>
                            </div>
                            <div class="progress-container">
                                <div class="progress-bar" style="width: ${Math.min(utilization, 100)}%"></div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Reports functions
            function loadReports() {
                updateReportStats();
            }

            function updateReportStats() {
                // Calculate total yield (simplified)
                const totalYield = farmData.projects.reduce((sum, project) => {
                    const baseYields = {
                        cabbage: 50, beetroot: 30, carrots: 40, onions: 35,
                        spinach: 20, cauliflower: 25, broccoli: 20, tomatoes: 50,
                        turnips: 30, lettuce: 25, kale: 20
                    };
                    return sum + (project.area * (baseYields[project.crop] || 30));
                }, 0);
                
                // Calculate ROI (simplified)
                const totalInvestment = farmData.investments.reduce((sum, inv) => sum + inv.amount, 0);
                const totalExpenses = farmData.expenses.reduce((sum, exp) => sum + exp.amount, 0);
                const roi = totalInvestment > 0 ? Math.round(((totalExpenses - totalInvestment) / totalInvestment) * 100) : 0;
                
                // Calculate labor cost
                const laborCost = farmData.attendance.reduce((sum, att) => {
                    if (att.status === 'full_day') return sum + 100;
                    if (att.status === 'half_day') return sum + 50;
                    return sum;
                }, 0);
                
                document.getElementById('totalYield').textContent = `${Math.round(totalYield)} kg`;
                document.getElementById('roi').textContent = `${roi}%`;
                document.getElementById('laborCost').textContent = formatCurrency(laborCost);
            }

            function generatePdfReport() {
                showNotification('PDF report generation would be implemented with jsPDF library', 'info');
            }

            function generateExcelReport() {
                showNotification('Excel report generation would be implemented with SheetJS library', 'info');
            }

            function exportData(type) {
                let data, filename, contentType;
                
                switch(type) {
                    case 'all':
                        data = JSON.stringify(farmData, null, 2);
                        filename = `mosehleng_farm_data_${getToday()}.json`;
                        contentType = 'application/json';
                        break;
                    case 'projects':
                        data = JSON.stringify(farmData.projects, null, 2);
                        filename = `projects_${getToday()}.json`;
                        contentType = 'application/json';
                        break;
                    case 'finances':
                        data = JSON.stringify({
                            financing: farmData.financing,
                            investments: farmData.investments,
                            budgets: farmData.budgets,
                            expenses: farmData.expenses
                        }, null, 2);
                        filename = `financial_data_${getToday()}.json`;
                        contentType = 'application/json';
                        break;
                    case 'investments':
                        data = JSON.stringify(farmData.investments, null, 2);
                        filename = `investments_${getToday()}.json`;
                        contentType = 'application/json';
                        break;
                    default:
                        return;
                }
                
                const blob = new Blob([data], { type: contentType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showNotification(`Data exported as ${filename}`, 'success');
            }

            // Public API
            return {
                init,
                showSection,
                showModal,
                closeModal,
                showNotification,
                updateAttendanceTime,
                editProject,
                viewProject,
                viewInvestment,
                loadBudgetTracking
            };
        })();

        // Global functions for inline event handlers
        function updateCropDetails() {
            FarmManager.updateCropDetails && FarmManager.updateCropDetails();
        }

        function calculateProjectDetails() {
            FarmManager.calculateProjectDetails && FarmManager.calculateProjectDetails();
        }

        function loadProjectTimeline() {
            FarmManager.loadProjectTimeline && FarmManager.loadProjectTimeline();
        }

        function toggleFinancingFields() {
            FarmManager.toggleFinancingFields && FarmManager.toggleFinancingFields();
        }

        function loadBudgetTracking() {
            FarmManager.loadBudgetTracking && FarmManager.loadBudgetTracking();
        }

        function closeModal(modalId) {
            FarmManager.closeModal && FarmManager.closeModal(modalId);
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            FarmManager.init();
        });

        // Close modals when clicking outside
        window.addEventListener('click', (event) => {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        });
    </script>
</body>
</html>